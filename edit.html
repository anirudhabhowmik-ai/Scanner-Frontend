<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Edit PDF Online Free | PDFMaster</title>
    <meta name="description" content="Edit PDF online: add text, images, shapes, draw, and annotate PDFs for free.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Inter:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="icon" href="./favicon.ico" type="image/x-icon">

    <style>
        .editor-container {
            display: none;
            margin-top: 30px;
        }

        .editor-layout {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .sidebar {
            width: 200px;
            flex-shrink: 0;
        }

        .main-editor {
            flex: 1;
            min-width: 0;
        }

        .toolbar {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .tool-btn {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #1e3a8a;
            position: relative;
        }

        .tool-btn:hover {
            background: #e5e7eb;
            border-color: #4f46e5;
        }

        .tool-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .tool-btn i {
            font-size: 16px;
        }

        /* Properties dropdown - appears below button */
        .properties-dropdown {
            display: none;
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            padding: 15px;
            z-index: 1000;
            width: max-content;
            max-width: 95vw;
        }

        .tool-btn.active .properties-dropdown {
            display: block;
        }

        .property-row {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .property-item {
            display: flex;
            flex-direction: column;
            align-items: start;
            gap: 8px;
        }

        .property-item .color-select {
            display: flex;
            gap: 2px;
        }

        .property-item label {
            font-size: 13px;
            font-weight: 500;
            color: #1e3a8a;
            white-space: nowrap;
        }

        .property-item input[type="number"],
        .property-item select {
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
            min-width: 80px;
        }

        .property-item input[type="color"] {
            width: 40px;
            height: 32px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
        }

        .property-item input[type="text"] {
            width: 80px;
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
        }

        /* Sidebar page thumbnails */
        .page-thumbnails {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .page-thumbnails h4 {
            margin: 0 0 15px 0;
            font-size: 14px;
            color: #1e3a8a;
        }

        .thumbnail-item {
            margin-bottom: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 8px;
            padding: 8px;
            transition: all 0.3s;
            background: #f9fafb;
        }

        .thumbnail-item:hover {
            border-color: #e5e7eb;
            background: #f3f4f6;
        }

        .thumbnail-item.active {
            border-color: #4f46e5;
            background: #eff6ff;
        }

        .thumbnail-item canvas {
            width: 100%;
            display: block;
            border-radius: 4px;
        }

        .thumbnail-item .page-label {
            text-align: center;
            margin-top: 5px;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
        }

        .thumbnail-item.active .page-label {
            color: #4f46e5;
        }

        .canvas-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            padding: 20px;
            position: relative;
            overflow: auto;
            max-height: calc(100vh - 200px);
        }

        .pdf-page-wrapper {
            position: relative;
            margin: 0 auto 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background: white;
            display: none;
        }

        .pdf-page-wrapper.active {
            display: block;
        }

        .pdf-canvas {
            display: block;
            width: 100%;
        }

        .annotation-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .annotation-item {
            position: absolute;
            pointer-events: all;
            cursor: move;
        }

        .text-annotation {
            border: 2px dashed transparent;
            padding: 5px;
            min-width: 100px;
            min-height: 30px;
            background: rgba(255, 255, 255, 0.9);
        }

        .text-annotation:hover,
        .text-annotation.selected {
            border-color: #4f46e5;
            background: rgba(255, 255, 255, 1);
        }

        .image-annotation {
            border: 2px solid transparent;
        }

        .image-annotation:hover,
        .image-annotation.selected {
            border-color: #4f46e5;
        }

        .image-annotation img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .shape-annotation {
            border: 2px solid #4f46e5;
        }

        .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: none;
            font-size: 12px;
        }

        .annotation-item.selected .delete-btn,
        .annotation-item:hover .delete-btn {
            display: block;
        }

        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #4f46e5;
            border: 1px solid white;
            display: none;
        }

        .annotation-item.selected .resize-handle,
        .annotation-item:hover .resize-handle {
            display: block;
        }

        .resize-handle.se {
            bottom: -5px;
            right: -5px;
            cursor: se-resize;
        }

        .resize-handle.ne {
            top: -5px;
            right: -5px;
            cursor: ne-resize;
        }

        .resize-handle.sw {
            bottom: -5px;
            left: -5px;
            cursor: sw-resize;
        }

        .resize-handle.nw {
            top: -5px;
            left: -5px;
            cursor: nw-resize;
        }

        input[type="file"].hidden {
            display: none;
        }

        .drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            display: none;
        }

        .drawing-canvas.active {
            display: block;
            pointer-events: all;
        }

        .file-info {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-info-left i {
            color: #ef4444;
            font-size: 24px;
        }

        .file-name-text {
            font-weight: 600;
            color: #1e3a8a;
        }

        .delete-file-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .delete-file-btn:hover {
            background: #dc2626;
        }

        .upload-loader {
            margin-top: 15px;
            text-align: center;
            color: #4f46e5;
            font-weight: 500;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 4px solid #e5e7eb;
            border-top-color: #4f46e5;
            border-radius: 50%;
            margin: 0 auto 8px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 1024px) {
            .editor-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                order: 2;
            }

            .main-editor {
                order: 1;
            }

            .page-thumbnails {
                max-height: 200px;
                overflow-x: auto;
                overflow-y: hidden;
                white-space: nowrap;
            }

            .thumbnail-item {
                display: inline-block;
                width: 120px;
                margin-right: 12px;
                vertical-align: top;
            }
        }

        @media (max-width: 768px) {
            .toolbar {
                gap: 8px;
            }

            .tool-btn {
                padding: 8px 12px;
                font-size: 13px;
            }
        }
    </style>
</head>

<body>

    <section id="header-placeholder"></section>

    <section class="merge-tool">
        <div class="container">
            <h1>Edit PDF</h1>
            <p>Add text, images, shapes, and annotations to your PDF.</p>

            <div class="upload-section">
                <div id="uploadSection">
                    <label for="pdfUpload" class="upload-label">
                        <i class="fa fa-upload"></i> Choose PDF file
                    </label>
                    <input type="file" id="pdfUpload" accept=".pdf">
                </div>

                <div id="uploadLoader" class="upload-loader" style="display:none;">
                    <div class="spinner"></div>
                    <p>Uploading & rendering PDFâ€¦</p>
                </div>

                <p id="errorMsg" class="error-text" style="display:none;"></p>
            </div>

            <div id="editorContainer" class="editor-container">
                <!-- File info with delete option -->
                <div class="file-info" id="fileInfo">
                    <div class="file-info-left">
                        <i class="fa fa-file-pdf"></i>
                        <span class="file-name-text" id="currentFileName">document.pdf</span>
                    </div>
                    <button class="delete-file-btn" id="deleteFileBtn">
                        <i class="fa fa-trash"></i>
                        Delete PDF
                    </button>
                </div>

                <!-- Toolbar with inline properties -->
                <div class="toolbar">
                    <button class="tool-btn" id="addTextBtn">
                        <i class="fa fa-font"></i> Add Text
                        <div class="properties-dropdown" id="textProperties">
                            <div class="property-row">
                                <div class="property-item">
                                    <label>Size:</label>
                                    <input type="number" id="fontSize" min="8" max="72" value="16">
                                </div>
                                <div class="property-item">
                                    <label>Font:</label>
                                    <select id="fontFamily">
                                        <option value="Arial">Arial</option>
                                        <option value="Helvetica">Helvetica</option>
                                        <option value="Times New Roman">Times</option>
                                        <option value="Courier New">Courier</option>
                                        <option value="Georgia">Georgia</option>
                                        <option value="Verdana">Verdana</option>
                                    </select>
                                </div>
                                <div class="property-item">
                                    <label>Color:</label>
                                    <div class="color-select">
                                        <input type="color" id="textColor" value="#000000">
                                        <input type="text" id="textColorHex" value="#000000" maxlength="7">
                                    </div>
                                </div>
                                <div class="property-item">
                                    <label>Font Weight:</label>
                                    <select id="fontWeight">
                                        <option value="normal">Normal</option>
                                        <option value="bold">Bold</option>
                                    </select>
                                </div>
                                <div class="property-item">
                                    <label>Font Style:</label>
                                    <select id="fontStyle">
                                        <option value="normal">Regular</option>
                                        <option value="italic">Italic</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </button>

                    <button class="tool-btn" id="addImageBtn">
                        <i class="fa fa-image"></i> Add Image
                    </button>

                    <button class="tool-btn" id="drawBtn">
                        <i class="fa fa-pencil"></i> Draw
                        <div class="properties-dropdown" id="drawProperties">
                            <div class="property-row">
                                <div class="property-item">
                                    <label>Color:</label>
                                    <div class="color-select">
                                        <input type="color" id="penColor" value="#000000">
                                        <input type="text" id="penColorHex" value="#000000" maxlength="7">
                                    </div>
                                </div>
                                <div class="property-item">
                                    <label>Width:</label>
                                    <input type="number" id="penWidth" min="1" max="20" value="3">
                                </div>
                            </div>
                        </div>
                    </button>

                    <button class="tool-btn" id="addShapeBtn">
                        <i class="fa fa-shapes"></i> Add Shape
                        <div class="properties-dropdown" id="shapeProperties">
                            <div class="property-row">
                                <div class="property-item">
                                    <label>Shape:</label>
                                    <select id="shapeType">
                                        <option value="rectangle">Rectangle</option>
                                        <option value="circle">Circle</option>
                                        <option value="line">Line</option>
                                    </select>
                                </div>
                                <div class="property-item">
                                    <label>Fill:</label>
                                    <div class="color-select">
                                        <input type="color" id="shapeFillColor" value="#4f46e5">
                                        <input type="text" id="shapeFillHex" value="#4f46e5" maxlength="7">
                                    </div>
                                </div>
                                <div class="property-item">
                                    <label>Border:</label>
                                    <div class="color-select">
                                        <input type="color" id="shapeBorderColor" value="#1e3a8a">
                                        <input type="text" id="shapeBorderHex" value="#1e3a8a" maxlength="7">
                                    </div>
                                </div>
                                <div class="property-item">
                                    <label>Width:</label>
                                    <input type="number" id="shapeBorderWidth" min="0" max="10" value="2">
                                </div>
                            </div>
                        </div>
                    </button>

                    <button class="tool-btn" id="undoBtn">
                        <i class="fa fa-undo"></i> Undo
                    </button>
                    <button class="tool-btn" id="clearAllBtn">
                        <i class="fa fa-eraser"></i> Clear All
                    </button>
                    <button class="cta-button" id="saveEditBtn">
                        <i class="fa fa-save"></i> Save PDF
                    </button>
                </div>

                <!-- Editor Layout: Sidebar + Main -->
                <div class="editor-layout">
                    <!-- Sidebar with page thumbnails -->
                    <div class="sidebar">
                        <div class="page-thumbnails">
                            <h4><i class="fa fa-images"></i> Pages</h4>
                            <div id="thumbnailContainer"></div>
                        </div>
                    </div>

                    <!-- Main canvas area -->
                    <div class="main-editor">
                        <div class="canvas-container" id="canvasContainer"></div>
                    </div>
                </div>

                <input type="file" id="imageUpload" accept="image/*" class="hidden">
            </div>

            <div id="resultBtns" style="display:none; margin-top:30px;">
                <div class="result-card">
                    <i class="fa fa-file-pdf"></i>
                </div>
                <p class="file-name">
                    <a href="#" id="fileNameLink">edited.pdf</a>
                </p>
                <a id="downloadBtn" href="#" class="cta-button">
                    <i class="fa fa-download"></i> Download PDF
                </a>
                <button id="resetBtn" class="secondary-btn">
                    <i class="fa fa-rotate-right"></i> Edit Another PDF
                </button>
            </div>

            <p id="noteText" class="note">
                Supported format: PDF. All editing is done in your browser.
            </p>
        </div>
    </section>

    <section id="footer-placeholder"></section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="./js/app.js"></script>

    <script>
        const { jsPDF } = window.jspdf;

        // DOM Elements
        const pdfUpload = document.getElementById('pdfUpload');
        const errorMsg = document.getElementById('errorMsg');
        const editorContainer = document.getElementById('editorContainer');
        const canvasContainer = document.getElementById('canvasContainer');
        const thumbnailContainer = document.getElementById('thumbnailContainer');
        const uploadSection = document.getElementById('uploadSection');
        const resultBtns = document.getElementById('resultBtns');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const fileInfo = document.getElementById('fileInfo');
        const currentFileName = document.getElementById('currentFileName');
        const deleteFileBtn = document.getElementById('deleteFileBtn');

        // Tool buttons
        const addTextBtn = document.getElementById('addTextBtn');
        const addImageBtn = document.getElementById('addImageBtn');
        const drawBtn = document.getElementById('drawBtn');
        const addShapeBtn = document.getElementById('addShapeBtn');
        const undoBtn = document.getElementById('undoBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const imageUpload = document.getElementById('imageUpload');

        // State
        let pdfDoc = null;
        let currentTool = null;
        let pages = [];
        let currentPageIndex = 0;
        let selectedAnnotation = null;
        let isDragging = false;
        let isResizing = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let resizeHandle = null;
        let uploadedFile = null;

        class PDFPage {
            constructor(pageNum, canvas, viewport) {
                this.pageNum = pageNum;
                this.canvas = canvas;
                this.viewport = viewport;
                this.annotations = [];
                this.drawingCanvas = null;
                this.wrapper = null;
                this.annotationLayer = null;
            }

            addAnnotation(annotation) {
                this.annotations.push(annotation);
            }

            removeAnnotation(annotation) {
                const index = this.annotations.indexOf(annotation);
                if (index > -1) {
                    this.annotations.splice(index, 1);
                }
            }
        }

        class Annotation {
            constructor(type, page) {
                this.type = type;
                this.page = page;
                this.element = null;
                this.x = 0;
                this.y = 0;
                this.width = 100;
                this.height = 50;
            }

            createElement() {
                const div = document.createElement('div');
                div.className = 'annotation-item';
                div.style.left = this.x + 'px';
                div.style.top = this.y + 'px';
                div.style.width = this.width + 'px';
                div.style.height = this.height + 'px';

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '<i class="fa fa-times"></i>';
                deleteBtn.onclick = () => this.delete();
                div.appendChild(deleteBtn);

                // Resize handles
                ['nw', 'ne', 'sw', 'se'].forEach(pos => {
                    const handle = document.createElement('div');
                    handle.className = `resize-handle ${pos}`;
                    handle.dataset.handle = pos;
                    div.appendChild(handle);
                });

                this.element = div;
                this.attachEvents();
                return div;
            }

            attachEvents() {
                this.element.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('resize-handle')) {
                        isResizing = true;
                        resizeHandle = e.target.dataset.handle;
                    } else if (!e.target.classList.contains('delete-btn')) {
                        isDragging = true;
                    }
                    selectAnnotation(this);
                    dragStartX = e.clientX - this.x;
                    dragStartY = e.clientY - this.y;
                    e.stopPropagation();
                });
            }

            updatePosition(x, y) {
                this.x = x;
                this.y = y;
                this.element.style.left = x + 'px';
                this.element.style.top = y + 'px';
            }

            updateSize(width, height) {
                this.width = Math.max(20, width);
                this.height = Math.max(20, height);
                this.element.style.width = this.width + 'px';
                this.element.style.height = this.height + 'px';
            }

            delete() {
                this.element.remove();
                this.page.removeAnnotation(this);
                selectedAnnotation = null;
            }
        }

        class TextAnnotation extends Annotation {
            constructor(page) {
                super('text', page);
                this.text = 'Double click to edit';
                this.fontSize = 16;
                this.fontFamily = 'Arial';
                this.color = '#000000';
                this.fontWeight = 'normal';
                this.fontStyle = 'normal';
            }

            createElement() {
                const div = super.createElement();
                div.classList.add('text-annotation');
                div.contentEditable = true;
                div.textContent = this.text;
                this.applyStyles();

                div.addEventListener('input', () => {
                    this.text = div.textContent;
                });

                return div;
            }

            applyStyles() {
                this.element.style.fontSize = this.fontSize + 'px';
                this.element.style.fontFamily = this.fontFamily;
                this.element.style.color = this.color;
                this.element.style.fontWeight = this.fontWeight;
                this.element.style.fontStyle = this.fontStyle;
            }

            updateProperty(prop, value) {
                this[prop] = value;
                this.applyStyles();
            }
        }

        class ImageAnnotation extends Annotation {
            constructor(page, imageSrc) {
                super('image', page);
                this.imageSrc = imageSrc;
                this.width = 150;
                this.height = 150;
            }

            createElement() {
                const div = super.createElement();
                div.classList.add('image-annotation');
                const img = document.createElement('img');
                img.src = this.imageSrc;
                div.appendChild(img);
                return div;
            }
        }

        class ShapeAnnotation extends Annotation {
            constructor(page, shapeType) {
                super('shape', page);
                this.shapeType = shapeType;
                this.fillColor = '#4f46e5';
                this.borderColor = '#1e3a8a';
                this.borderWidth = 2;
            }

            createElement() {
                const div = super.createElement();
                div.classList.add('shape-annotation');
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.style.width = '100%';
                svg.style.height = '100%';
                svg.style.pointerEvents = 'none';

                this.svg = svg;
                this.updateShape();
                div.appendChild(svg);
                return div;
            }

            updateShape() {
                this.svg.innerHTML = '';

                if (this.shapeType === 'rectangle') {
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('width', '100%');
                    rect.setAttribute('height', '100%');
                    rect.setAttribute('fill', this.fillColor);
                    rect.setAttribute('stroke', this.borderColor);
                    rect.setAttribute('stroke-width', this.borderWidth);
                    this.svg.appendChild(rect);
                } else if (this.shapeType === 'circle') {
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', '50%');
                    circle.setAttribute('cy', '50%');
                    circle.setAttribute('r', '45%');
                    circle.setAttribute('fill', this.fillColor);
                    circle.setAttribute('stroke', this.borderColor);
                    circle.setAttribute('stroke-width', this.borderWidth);
                    this.svg.appendChild(circle);
                } else if (this.shapeType === 'line') {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', '0');
                    line.setAttribute('y1', '50%');
                    line.setAttribute('x2', '100%');
                    line.setAttribute('y2', '50%');
                    line.setAttribute('stroke', this.borderColor);
                    line.setAttribute('stroke-width', this.borderWidth);
                    this.svg.appendChild(line);
                }
            }

            updateProperty(prop, value) {
                this[prop] = value;
                this.updateShape();
            }
        }

        // Event Listeners
        pdfUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            uploadedFile = file;
            currentFileName.textContent = file.name;

            document.getElementById('uploadLoader').style.display = 'block';

            await loadPDF(file);

            document.getElementById('uploadLoader').style.display = 'none';
        });

        async function loadPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            canvasContainer.innerHTML = '';
            thumbnailContainer.innerHTML = '';
            pages = [];

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });

                // Main canvas
                const wrapper = document.createElement('div');
                wrapper.className = 'pdf-page-wrapper';
                wrapper.style.width = viewport.width + 'px';
                if (i === 1) wrapper.classList.add('active');

                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-canvas';
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                const context = canvas.getContext('2d');
                await page.render({ canvasContext: context, viewport: viewport }).promise;

                const annotationLayer = document.createElement('div');
                annotationLayer.className = 'annotation-layer';
                annotationLayer.style.width = viewport.width + 'px';
                annotationLayer.style.height = viewport.height + 'px';

                const drawingCanvas = document.createElement('canvas');
                drawingCanvas.className = 'drawing-canvas';
                drawingCanvas.width = viewport.width;
                drawingCanvas.height = viewport.height;

                wrapper.appendChild(canvas);
                wrapper.appendChild(annotationLayer);
                wrapper.appendChild(drawingCanvas);
                canvasContainer.appendChild(wrapper);

                // Thumbnail
                const thumbViewport = page.getViewport({ scale: 0.2 });
                const thumbCanvas = document.createElement('canvas');
                thumbCanvas.width = thumbViewport.width;
                thumbCanvas.height = thumbViewport.height;
                const thumbContext = thumbCanvas.getContext('2d');
                await page.render({ canvasContext: thumbContext, viewport: thumbViewport }).promise;

                const thumbItem = document.createElement('div');
                thumbItem.className = 'thumbnail-item';
                if (i === 1) thumbItem.classList.add('active');
                thumbItem.dataset.page = i - 1;
                thumbItem.appendChild(thumbCanvas);

                const pageLabel = document.createElement('div');
                pageLabel.className = 'page-label';
                pageLabel.textContent = `Page ${i}`;
                thumbItem.appendChild(pageLabel);

                thumbItem.addEventListener('click', () => switchToPage(i - 1));
                thumbnailContainer.appendChild(thumbItem);

                const pdfPage = new PDFPage(i, canvas, viewport);
                pdfPage.wrapper = wrapper;
                pdfPage.annotationLayer = annotationLayer;
                pdfPage.drawingCanvas = drawingCanvas;
                pages.push(pdfPage);

                setupDrawing(pdfPage);
            }

            editorContainer.style.display = 'block';
            uploadSection.style.display = 'none';
        }

        function switchToPage(index) {
            currentPageIndex = index;

            // Update main canvas
            pages.forEach((page, i) => {
                if (i === index) {
                    page.wrapper.classList.add('active');
                } else {
                    page.wrapper.classList.remove('active');
                }
            });

            // Update thumbnails
            document.querySelectorAll('.thumbnail-item').forEach((thumb, i) => {
                if (i === index) {
                    thumb.classList.add('active');
                } else {
                    thumb.classList.remove('active');
                }
            });

            // Scroll thumbnail into view
            const activeThumb = thumbnailContainer.children[index];
            if (activeThumb) {
                activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        function setupDrawing(page) {
            const canvas = page.drawingCanvas;
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            canvas.addEventListener('mousedown', (e) => {
                if (currentTool !== 'draw') return;
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing || currentTool !== 'draw') return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                ctx.strokeStyle = document.getElementById('penColor').value;
                ctx.lineWidth = parseInt(document.getElementById('penWidth').value);
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();

                lastX = x;
                lastY = y;
            });

            canvas.addEventListener('mouseup', () => {
                isDrawing = false;
            });

            canvas.addEventListener('mouseleave', () => {
                isDrawing = false;
            });
        }

        // Tool handlers
        addTextBtn.addEventListener('click', () => {
            setTool('text');
        });

        addImageBtn.addEventListener('click', () => {
            imageUpload.click();
        });

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                setTool('image', event.target.result);
            };
            reader.readAsDataURL(file);
        });

        drawBtn.addEventListener('click', () => {
            setTool('draw');
        });

        addShapeBtn.addEventListener('click', () => {
            setTool('shape');
        });

        function setTool(tool, data = null) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));

            if (tool === 'text') addTextBtn.classList.add('active');
            else if (tool === 'draw') drawBtn.classList.add('active');
            else if (tool === 'shape') addShapeBtn.classList.add('active');

            pages.forEach(page => {
                if (tool === 'draw') {
                    page.drawingCanvas.classList.add('active');
                } else {
                    page.drawingCanvas.classList.remove('active');
                }

                if (tool === 'text' || tool === 'image' || tool === 'shape') {
                    page.annotationLayer.style.pointerEvents = 'all';
                    page.annotationLayer.onclick = (e) => {
                        if (e.target === page.annotationLayer) {
                            addAnnotationToPage(page, tool, e, data);
                        }
                    };
                } else {
                    page.annotationLayer.style.pointerEvents = 'none';
                }
            });
        }

        function addAnnotationToPage(page, type, e, data) {
            const rect = page.annotationLayer.getBoundingClientRect();
            let annotation;

            if (type === 'text') {
                annotation = new TextAnnotation(page);
                annotation.fontSize = parseInt(document.getElementById('fontSize').value);
                annotation.fontFamily = document.getElementById('fontFamily').value;
                annotation.color = document.getElementById('textColor').value;
                annotation.fontWeight = document.getElementById('fontWeight').value;
                annotation.fontStyle = document.getElementById('fontStyle').value;
            } else if (type === 'image') {
                annotation = new ImageAnnotation(page, data);
            } else if (type === 'shape') {
                const shapeType = document.getElementById('shapeType').value;
                annotation = new ShapeAnnotation(page, shapeType);
                annotation.fillColor = document.getElementById('shapeFillColor').value;
                annotation.borderColor = document.getElementById('shapeBorderColor').value;
                annotation.borderWidth = parseInt(document.getElementById('shapeBorderWidth').value);
            }

            if (annotation) {
                annotation.x = e.clientX - rect.left - 50;
                annotation.y = e.clientY - rect.top - 25;
                const element = annotation.createElement();
                page.annotationLayer.appendChild(element);
                page.addAnnotation(annotation);
            }
        }

        function selectAnnotation(annotation) {
            if (selectedAnnotation) {
                selectedAnnotation.element.classList.remove('selected');
            }
            selectedAnnotation = annotation;
            annotation.element.classList.add('selected');

            if (annotation.type === 'text') {
                document.getElementById('fontSize').value = annotation.fontSize;
                document.getElementById('fontFamily').value = annotation.fontFamily;
                document.getElementById('textColor').value = annotation.color;
                document.getElementById('textColorHex').value = annotation.color;
                document.getElementById('fontWeight').value = annotation.fontWeight;
                document.getElementById('fontStyle').value = annotation.fontStyle;
            } else if (annotation.type === 'shape') {
                document.getElementById('shapeType').value = annotation.shapeType;
                document.getElementById('shapeFillColor').value = annotation.fillColor;
                document.getElementById('shapeFillHex').value = annotation.fillColor;
                document.getElementById('shapeBorderColor').value = annotation.borderColor;
                document.getElementById('shapeBorderHex').value = annotation.borderColor;
                document.getElementById('shapeBorderWidth').value = annotation.borderWidth;
            }
        }

        // Property change handlers
        document.getElementById('fontSize').addEventListener('input', (e) => {
            if (selectedAnnotation && selectedAnnotation.type === 'text') {
                selectedAnnotation.updateProperty('fontSize', parseInt(e.target.value));
            }
        });

        document.getElementById('fontFamily').addEventListener('change', (e) => {
            if (selectedAnnotation && selectedAnnotation.type === 'text') {
                selectedAnnotation.updateProperty('fontFamily', e.target.value);
            }
        });

        document.getElementById('textColor').addEventListener('input', (e) => {
            document.getElementById('textColorHex').value = e.target.value;
            if (selectedAnnotation && selectedAnnotation.type === 'text') {
                selectedAnnotation.updateProperty('color', e.target.value);
            }
        });

        document.getElementById('textColorHex').addEventListener('input', (e) => {
            const color = e.target.value;
            if (/^#[0-9A-F]{6}$/i.test(color)) {
                document.getElementById('textColor').value = color;
                if (selectedAnnotation && selectedAnnotation.type === 'text') {
                    selectedAnnotation.updateProperty('color', color);
                }
            }
        });

        document.getElementById('fontWeight').addEventListener('change', (e) => {
            if (selectedAnnotation && selectedAnnotation.type === 'text') {
                selectedAnnotation.updateProperty('fontWeight', e.target.value);
            }
        });

        document.getElementById('fontStyle').addEventListener('change', (e) => {
            if (selectedAnnotation && selectedAnnotation.type === 'text') {
                selectedAnnotation.updateProperty('fontStyle', e.target.value);
            }
        });

        // Shape properties
        document.getElementById('shapeType').addEventListener('change', (e) => {
            if (selectedAnnotation && selectedAnnotation.type === 'shape') {
                selectedAnnotation.updateProperty('shapeType', e.target.value);
            }
        });

        document.getElementById('shapeFillColor').addEventListener('input', (e) => {
            document.getElementById('shapeFillHex').value = e.target.value;
            if (selectedAnnotation && selectedAnnotation.type === 'shape') {
                selectedAnnotation.updateProperty('fillColor', e.target.value);
            }
        });

        document.getElementById('shapeFillHex').addEventListener('input', (e) => {
            const color = e.target.value;
            if (/^#[0-9A-F]{6}$/i.test(color)) {
                document.getElementById('shapeFillColor').value = color;
                if (selectedAnnotation && selectedAnnotation.type === 'shape') {
                    selectedAnnotation.updateProperty('fillColor', color);
                }
            }
        });

        document.getElementById('shapeBorderColor').addEventListener('input', (e) => {
            document.getElementById('shapeBorderHex').value = e.target.value;
            if (selectedAnnotation && selectedAnnotation.type === 'shape') {
                selectedAnnotation.updateProperty('borderColor', e.target.value);
            }
        });

        document.getElementById('shapeBorderHex').addEventListener('input', (e) => {
            const color = e.target.value;
            if (/^#[0-9A-F]{6}$/i.test(color)) {
                document.getElementById('shapeBorderColor').value = color;
                if (selectedAnnotation && selectedAnnotation.type === 'shape') {
                    selectedAnnotation.updateProperty('borderColor', color);
                }
            }
        });

        document.getElementById('shapeBorderWidth').addEventListener('input', (e) => {
            if (selectedAnnotation && selectedAnnotation.type === 'shape') {
                selectedAnnotation.updateProperty('borderWidth', parseInt(e.target.value));
            }
        });

        // Pen properties
        document.getElementById('penColor').addEventListener('input', (e) => {
            document.getElementById('penColorHex').value = e.target.value;
        });

        document.getElementById('penColorHex').addEventListener('input', (e) => {
            const color = e.target.value;
            if (/^#[0-9A-F]{6}$/i.test(color)) {
                document.getElementById('penColor').value = color;
            }
        });

        // Mouse events for dragging and resizing
        document.addEventListener('mousemove', (e) => {
            if (isDragging && selectedAnnotation) {
                const rect = selectedAnnotation.page.annotationLayer.getBoundingClientRect();
                const x = e.clientX - rect.left - dragStartX + selectedAnnotation.x;
                const y = e.clientY - rect.top - dragStartY + selectedAnnotation.y;
                selectedAnnotation.updatePosition(
                    Math.max(0, Math.min(x, rect.width - selectedAnnotation.width)),
                    Math.max(0, Math.min(y, rect.height - selectedAnnotation.height))
                );
            } else if (isResizing && selectedAnnotation) {
                const rect = selectedAnnotation.page.annotationLayer.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                let newWidth = selectedAnnotation.width;
                let newHeight = selectedAnnotation.height;
                let newX = selectedAnnotation.x;
                let newY = selectedAnnotation.y;

                if (resizeHandle.includes('e')) {
                    newWidth = mouseX - selectedAnnotation.x;
                }
                if (resizeHandle.includes('w')) {
                    newWidth = selectedAnnotation.width + (selectedAnnotation.x - mouseX);
                    newX = mouseX;
                }
                if (resizeHandle.includes('s')) {
                    newHeight = mouseY - selectedAnnotation.y;
                }
                if (resizeHandle.includes('n')) {
                    newHeight = selectedAnnotation.height + (selectedAnnotation.y - mouseY);
                    newY = mouseY;
                }

                if (newWidth > 20 && newHeight > 20) {
                    selectedAnnotation.updateSize(newWidth, newHeight);
                    if (newX !== selectedAnnotation.x || newY !== selectedAnnotation.y) {
                        selectedAnnotation.updatePosition(newX, newY);
                    }
                }
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            isResizing = false;
            resizeHandle = null;
        });

        // Undo functionality
        undoBtn.addEventListener('click', () => {
            const currentPage = pages[currentPageIndex];
            if (currentPage.annotations.length > 0) {
                const lastAnnotation = currentPage.annotations[currentPage.annotations.length - 1];
                lastAnnotation.delete();
            }
        });

        // Clear all
        clearAllBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all annotations on this page?')) {
                const currentPage = pages[currentPageIndex];
                currentPage.annotations.forEach(ann => ann.element.remove());
                currentPage.annotations = [];
                const ctx = currentPage.drawingCanvas.getContext('2d');
                ctx.clearRect(0, 0, currentPage.drawingCanvas.width, currentPage.drawingCanvas.height);
                selectedAnnotation = null;
            }
        });

        // Delete file button
        deleteFileBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete this PDF and start over?')) {
                location.reload();
            }
        });

        // Save PDF
        saveEditBtn.addEventListener('click', async () => {
            try {
                saveEditBtn.disabled = true;
                saveEditBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Saving...';

                // Prepare annotations data for backend
                const annotationsData = pages.map(page => {
                    const pageAnnotations = page.annotations.map(ann => {
                        const baseAnn = {
                            type: ann.type,
                            x: ann.x,
                            y: ann.y,
                            width: ann.width,
                            height: ann.height
                        };

                        if (ann.type === 'text') {
                            return {
                                ...baseAnn,
                                text: ann.text,
                                fontSize: ann.fontSize,
                                fontFamily: ann.fontFamily,
                                color: ann.color,
                                fontWeight: ann.fontWeight,
                                fontStyle: ann.fontStyle
                            };
                        } else if (ann.type === 'image') {
                            return {
                                ...baseAnn,
                                imageData: ann.imageSrc
                            };
                        } else if (ann.type === 'shape') {
                            return {
                                ...baseAnn,
                                shapeType: ann.shapeType,
                                fillColor: ann.fillColor,
                                borderColor: ann.borderColor,
                                borderWidth: ann.borderWidth
                            };
                        }
                    });

                    // Get drawing data if exists
                    const ctx = page.drawingCanvas.getContext('2d');
                    const imageData = ctx.getImageData(0, 0, page.drawingCanvas.width, page.drawingCanvas.height);
                    const hasDrawing = imageData.data.some(pixel => pixel !== 0);

                    return {
                        pageNum: page.pageNum,
                        annotations: pageAnnotations,
                        drawing: hasDrawing ? page.drawingCanvas.toDataURL('image/png') : null
                    };
                });

                // Send to backend
                const formData = new FormData();
                formData.append('file', uploadedFile);
                formData.append('annotations', JSON.stringify(annotationsData));

                const response = await fetch(`${BACKEND_BASE_URL}/edit-pdf`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Failed to save PDF');
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                downloadBtn.href = url;
                downloadBtn.download = 'edited.pdf';

                editorContainer.style.display = 'none';
                resultBtns.style.display = 'block';

            } catch (error) {
                alert('Error saving PDF: ' + error.message);
                saveEditBtn.disabled = false;
                saveEditBtn.innerHTML = '<i class="fa fa-save"></i> Save PDF';
            }
        });

        // Reset
        resetBtn.addEventListener('click', () => {
            location.reload();
        });





        const toolButtons = document.querySelectorAll('.tool-btn');
        const toolBoxes = document.querySelectorAll('.tool-box');

        toolButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();

                const targetId = btn.dataset.target;
                if (!targetId) return;

                const targetBox = document.getElementById(targetId);
                if (!targetBox) return;

                // Close all
                toolButtons.forEach(b => b.classList.remove('active'));
                toolBoxes.forEach(box => box.classList.remove('active'));

                // Open current
                btn.classList.add('active');
                targetBox.classList.add('active');
            });
        });

        // Click outside closes all
        document.addEventListener('click', () => {
            toolButtons.forEach(b => b.classList.remove('active'));
            toolBoxes.forEach(box => box.classList.remove('active'));
        });

        // Prevent close when clicking inside dropdown
        toolBoxes.forEach(box => {
            box.addEventListener('click', e => e.stopPropagation());
        });



    </script>

</body>

</html>