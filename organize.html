<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <!-- SEO -->
    <title>Organize PDF Pages Online Free | PDFMaster</title>
    <meta
      name="description"
      content="Organize PDF pages online. Drag, delete, reorder and add blank pages easily."
    />
    <meta name="keywords" content="organize pdf, reorder pdf, edit pdf pages" />
    <meta name="author" content="PDFMaster" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Inter:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="icon" href="./favicon.ico" type="image/x-icon" />

    <style>
      .pages-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-top: 30px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        border: 2px dashed #e5e7eb;
        min-height: 200px;
        position: relative;
      }

      .pages-grid:empty::after {
        content: "Upload a PDF to see pages here";
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        color: #9ca3af;
        font-size: 16px;
        text-align: center;
      }

      .page-card {
        position: relative;
        background: #fff;
        border-radius: 12px;
        padding: 12px;
        cursor: grab;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        border: 2px solid transparent;
        overflow: visible;
      }

      .page-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        border-color: #4f46e5;
      }

      .page-card.dragging {
        opacity: 0.5;
        cursor: grabbing;
      }

      .page-card.drag-over {
        border-color: #4f46e5;
        background: #f0f4ff;
      }

      .page-number {
        position: absolute;
        top: 8px;
        left: 8px;
        background: #4f46e5;
        color: white;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        z-index: 10;
      }

      .page-canvas-wrapper {
        position: relative;
        width: 100%;
        height: 200px;
        overflow: visible;
        border-radius: 8px;
        background: #f9fafb;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .page-card canvas {
        max-width: 100%;
        max-height: 100%;
        display: block;
        border-radius: 8px;
        transition: transform 0.3s ease;
      }

      .blank-page {
        width: 100%;
        height: 100%;
        background: white;
        border: 2px dashed #cbd5e1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        font-weight: 600;
        border-radius: 8px;
        transition: transform 0.3s ease;
      }

      .page-actions {
        display: flex;
        justify-content: space-around;
        margin-top: 12px;
        gap: 8px;
      }

      .page-actions button {
        background: #f3f4f6;
        border: none;
        cursor: pointer;
        color: #4b5563;
        font-size: 14px;
        padding: 8px 4px;
        border-radius: 8px;
        transition: all 0.2s;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .page-actions button:hover {
        background: #e5e7eb;
        transform: scale(1.05);
      }

      .page-actions button.delete:hover {
        background: #fee2e2;
        color: #dc2626;
      }

      .page-actions button.rotate:hover {
        background: #dbeafe;
        color: #2563eb;
      }

      .page-actions button.add:hover {
        background: #d1fae5;
        color: #059669;
      }

      /* Loader inside button */
      .btn-loading .btn-spinner {
        display: inline-block;
        margin-right: 8px;
      }

      .btn-loading .btn-text {
        display: none;
      }

      .btn-spinner {
        display: none;
      }

      .result-btns-container {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 20px;
      }

      @media (max-width: 1024px) {
        .pages-grid {
          grid-template-columns: repeat(3, 1fr);
          gap: 18px;
        }
      }

      @media (max-width: 768px) {
        .pages-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 15px;
          padding: 15px;
        }

        .page-canvas-wrapper {
          height: 180px;
        }

        .result-btns-container {
          flex-direction: column;
        }
      }

      @media (max-width: 480px) {
        .pages-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
        }

        .page-canvas-wrapper {
          height: 160px;
        }
      }
    </style>
  </head>

  <body>
    <section id="header-placeholder"></section>

    <section class="merge-tool">
      <div class="container">
        <h1>Organize PDF Pages</h1>
        <p>Drag & drop pages to reorder, rotate, delete, or add blank pages.</p>

        <div class="upload-section">
          <div id="uploadSection">
            <label class="upload-label" for="pdfUpload">
              <i class="fa fa-upload"></i> Choose PDF files
            </label>
            <input type="file" id="pdfUpload" accept=".pdf" multiple />
          </div>

          <ul id="fileList" class="file-list" style="display: none"></ul>

          <div id="pagesGrid" class="pages-grid" style="display: none"></div>

          <button id="organizeBtn" class="cta-button" style="margin-top: 15px">
            <span class="btn-spinner">
              <i class="fa fa-spinner fa-spin"></i>
            </span>
            <span class="btn-text"><i class="fa fa-layer-group"></i></span>
            Organize PDF
          </button>

          <p class="error-text" id="errorMsg" style="display: none"></p>

          <div id="resultBtns" style="display: none; margin-top: 30px">
            <div class="result-card">
              <i class="fa fa-file-pdf"></i>
            </div>

            <p class="file-name">
              <a href="#" id="fileNameLink">organized.pdf</a>
            </p>

            <div class="result-btns-container">
              <a id="downloadBtn" href="#" class="cta-button">
                <i class="fa fa-download"></i> Download
              </a>
              <a id="shareBtn" href="#" class="cta-button">
                <i class="fa fa-share-alt"></i> Share
              </a>
              <button id="resetBtn" class="secondary-btn">
                <i class="fa fa-rotate-right"></i> Organize Another PDF
              </button>
            </div>
          </div>

          <p class="note" id="noteText">
            Supported format: PDF. Select one file at a time, or use Ctrl
            (desktop only) to select multiple files.
          </p>
        </div>

        <!-- Show Preview -->
        <div id="pdfPreview" style="display: none; margin-top: 30px">
          <h4>Preview Organized PDF</h4>
          <iframe
            id="pdfFrame"
            width="100%"
            height="600"
            style="border-radius: 12px; border: 1px solid #e5e7eb"
          ></iframe>
        </div>
      </div>
    </section>

    <section id="footer-placeholder"></section>

    <script src="./js/app.js"></script>

    <!-- pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
      const BACKEND_ORGANIZE_URL = `${BACKEND_BASE_URL}/organize-pdf`;

      const pdfUpload = document.getElementById("pdfUpload");
      const fileList = document.getElementById("fileList");
      const pagesGrid = document.getElementById("pagesGrid");
      const organizeBtn = document.getElementById("organizeBtn");
      const downloadBtn = document.getElementById("downloadBtn");
      const shareBtn = document.getElementById("shareBtn");
      const resetBtn = document.getElementById("resetBtn");
      const errorMsg = document.getElementById("errorMsg");
      const uploadSection = document.getElementById("uploadSection");
      const resultBtns = document.getElementById("resultBtns");
      const noteText = document.getElementById("noteText");
      const pdfPreview = document.getElementById("pdfPreview");
      const pdfFrame = document.getElementById("pdfFrame");
      const fileNameLink = document.getElementById("fileNameLink");
      const loaderIcon = organizeBtn.querySelector(".btn-spinner");

      let files = [];
      let draggedElement = null;
      let allPages = []; // Store all pages from all PDFs

      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

      function clearError() {
        errorMsg.textContent = "";
        errorMsg.style.display = "none";
      }

      // Render file list
      function renderFileList() {
        fileList.style.display = "block";
        fileList.innerHTML = "";
        files.forEach((file, index) => {
          const li = document.createElement("li");
          li.innerHTML = `<i class="fa fa-file-pdf pdf-icon"></i> <span>${file.name}</span> <i class="fa fa-times delete-file" data-index="${index}"></i>`;
          fileList.appendChild(li);
        });
      }

      /* ================= LOAD PDF ================= */
      pdfUpload.addEventListener("change", async () => {
        clearError();
        const newFiles = Array.from(pdfUpload.files);

        // Avoid duplicates
        newFiles.forEach((file) => {
          if (
            !files.some((f) => f.name === file.name && f.size === file.size)
          ) {
            files.push(file);
          }
        });

        renderFileList();

        // Reset input
        pdfUpload.value = "";

        // Load all PDFs
        pagesGrid.innerHTML = "";
        pagesGrid.style.display = "grid";
        allPages = [];

        try {
          for (let fileIndex = 0; fileIndex < files.length; fileIndex++) {
            const file = files[fileIndex];
            const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file))
              .promise;

            for (let i = 1; i <= pdf.numPages; i++) {
              await renderPage(pdf, i, allPages.length, fileIndex);
              allPages.push({ fileIndex, pageIndex: i - 1 });
            }
          }
        } catch (error) {
          errorMsg.textContent = "Error loading PDF: " + error.message;
          errorMsg.style.display = "block";
        }
      });

      /* ================= DELETE FILE ================= */
      fileList.addEventListener("click", async (e) => {
        if (e.target.classList.contains("delete-file")) {
          const index = parseInt(e.target.dataset.index);
          files.splice(index, 1);

          if (files.length === 0) {
            fileList.style.display = "none";
            pagesGrid.innerHTML = "";
            pagesGrid.style.display = "none";
            allPages = [];
          } else {
            renderFileList();
            // Reload all PDFs
            pagesGrid.innerHTML = "";
            allPages = [];

            for (let fileIndex = 0; fileIndex < files.length; fileIndex++) {
              const file = files[fileIndex];
              const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file))
                .promise;

              for (let i = 1; i <= pdf.numPages; i++) {
                await renderPage(pdf, i, allPages.length, fileIndex);
                allPages.push({ fileIndex, pageIndex: i - 1 });
              }
            }
          }

          clearError();
        }
      });

      /* ================= RENDER PAGE ================= */
      async function renderPage(pdf, pageNum, globalIndex, fileIndex) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 1 });

        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({
          canvasContext: context,
          viewport: viewport,
        }).promise;

        const card = createPageCard(
          canvas,
          globalIndex,
          pageNum,
          fileIndex,
          false,
        );
        pagesGrid.appendChild(card);
      }

      /* ================= CREATE CARD ================= */
      function createPageCard(
        content,
        globalIndex,
        pageNum,
        fileIndex,
        isBlank,
      ) {
        const card = document.createElement("div");
        card.className = "page-card";
        card.draggable = true;
        card.dataset.type = isBlank ? "blank" : "page";
        card.dataset.globalIndex = globalIndex ?? "";
        card.dataset.fileIndex = fileIndex ?? "";
        card.dataset.rotation = "0";

        if (!isBlank) {
          const badge = document.createElement("div");
          badge.className = "page-number";
          badge.textContent = `Page ${pageNum}`;
          card.appendChild(badge);
        }

        const wrapper = document.createElement("div");
        wrapper.className = "page-canvas-wrapper";

        if (isBlank) {
          const blankDiv = document.createElement("div");
          blankDiv.className = "blank-page";
          blankDiv.innerHTML =
            '<i class="fa fa-file" style="font-size:24px;"></i>';
          wrapper.appendChild(blankDiv);
        } else {
          wrapper.appendChild(content);
        }

        card.appendChild(wrapper);

        const actions = document.createElement("div");
        actions.className = "page-actions";

        // Rotate button
        const rotateBtn = document.createElement("button");
        rotateBtn.className = "rotate";
        rotateBtn.innerHTML = '<i class="fa fa-rotate-right"></i>';
        rotateBtn.title = "Rotate";
        rotateBtn.onclick = (e) => {
          e.stopPropagation();
          const currentRotation = Number(card.dataset.rotation);
          const newRotation = (currentRotation + 90) % 360;
          card.dataset.rotation = newRotation;

          const contentElement = wrapper.querySelector("canvas, .blank-page");
          if (contentElement) {
            const isVertical = newRotation === 90 || newRotation === 270;
            const scale = isVertical ? 0.7 : 1;
            contentElement.style.transform = `rotate(${newRotation}deg) scale(${scale})`;
          }
        };

        // Add blank button
        const addBlankBtn = document.createElement("button");
        addBlankBtn.className = "add";
        addBlankBtn.innerHTML = '<i class="fa fa-plus"></i>';
        addBlankBtn.title = "Add blank page after";
        addBlankBtn.onclick = (e) => {
          e.stopPropagation();
          const blankCanvas = document.createElement("div");
          const blankCard = createPageCard(blankCanvas, null, null, null, true);
          card.parentNode.insertBefore(blankCard, card.nextSibling);
          updatePageNumbers();
        };

        // Delete button
        const delBtn = document.createElement("button");
        delBtn.className = "delete";
        delBtn.innerHTML = '<i class="fa fa-trash"></i>';
        delBtn.title = "Delete";
        delBtn.onclick = (e) => {
          e.stopPropagation();
          card.remove();
          updatePageNumbers();
        };

        actions.append(rotateBtn, addBlankBtn, delBtn);
        card.appendChild(actions);

        setupDragAndDrop(card);
        return card;
      }

      /* ================= DRAG & DROP ================= */
      function setupDragAndDrop(card) {
        card.addEventListener("dragstart", (e) => {
          draggedElement = card;
          card.classList.add("dragging");
          e.dataTransfer.effectAllowed = "move";
        });

        card.addEventListener("dragend", () => {
          card.classList.remove("dragging");
          document
            .querySelectorAll(".page-card")
            .forEach((c) => c.classList.remove("drag-over"));
          draggedElement = null;
          updatePageNumbers();
        });

        card.addEventListener("dragover", (e) => {
          e.preventDefault();
          if (!draggedElement || draggedElement === card) return;

          const afterElement = getDragAfterElement(pagesGrid, e.clientY);

          if (afterElement == null) {
            pagesGrid.appendChild(draggedElement);
          } else {
            pagesGrid.insertBefore(draggedElement, afterElement);
          }
        });

        card.addEventListener("dragenter", (e) => {
          e.preventDefault();
          if (draggedElement && draggedElement !== card) {
            card.classList.add("drag-over");
          }
        });

        card.addEventListener("dragleave", () => {
          card.classList.remove("drag-over");
        });
      }

      function getDragAfterElement(container, y) {
        const draggableElements = [
          ...container.querySelectorAll(".page-card:not(.dragging)"),
        ];

        return draggableElements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;

            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY },
        ).element;
      }

      function updatePageNumbers() {
        const cards = pagesGrid.querySelectorAll(".page-card");
        let pageCount = 1;
        cards.forEach((card) => {
          const badge = card.querySelector(".page-number");
          if (badge && card.dataset.type === "page") {
            badge.textContent = `Page ${pageCount}`;
            pageCount++;
          }
        });
      }

      /* ================= ORGANIZE ================= */
      organizeBtn.addEventListener("click", async () => {
        clearError();

        if (files.length === 0) {
          errorMsg.textContent = "Please upload at least one PDF file";
          errorMsg.style.display = "block";
          return;
        }

        const cards = [...pagesGrid.children];

        if (cards.length === 0) {
          errorMsg.textContent = "No pages to organize";
          errorMsg.style.display = "block";
          return;
        }

        const layout = cards.map((card) => {
          if (card.dataset.type === "blank") {
            return {
              type: "blank",
              rotation: Number(card.dataset.rotation),
            };
          } else {
            return {
              type: "page",
              fileIndex: Number(card.dataset.fileIndex),
              pageIndex: Number(card.dataset.globalIndex),
              rotation: Number(card.dataset.rotation),
            };
          }
        });

        const formData = new FormData();
        files.forEach((f) => formData.append("files", f));
        formData.append("layout", JSON.stringify(layout));

        organizeBtn.disabled = true;
        organizeBtn.classList.add("btn-loading");
        loaderIcon.style.display = "inline-block";

        try {
          const res = await fetch(BACKEND_ORGANIZE_URL, {
            method: "POST",
            body: formData,
          });

          if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.error || "Failed to organize PDF");
          }

          const blob = await res.blob();
          const url = URL.createObjectURL(blob);

          downloadBtn.href = url;
          downloadBtn.download = "organized.pdf";
          shareBtn.href = url;

          uploadSection.style.display = "none";
          fileList.style.display = "none";
          pagesGrid.style.display = "none";
          organizeBtn.style.display = "none";
          noteText.style.display = "none";
          resultBtns.style.display = "block";

          const isSmallDevice = window.matchMedia("(max-width: 768px)").matches;

          if (!isSmallDevice) {
            pdfFrame.src = url;
            pdfPreview.style.display = "block";
          }

          fileNameLink.onclick = (e) => {
            e.preventDefault();
            isSmallDevice
              ? window.open(url, "_blank")
              : pdfPreview.scrollIntoView({ behavior: "smooth" });
          };
        } catch (error) {
          errorMsg.textContent = "Error: " + error.message;
          errorMsg.style.display = "block";
        } finally {
          organizeBtn.disabled = false;
          organizeBtn.classList.remove("btn-loading");
          loaderIcon.style.display = "none";
        }
      });

      /* ================= RESET ================= */
      resetBtn.addEventListener("click", () => {
        clearError();
        files = [];
        pdfUpload.value = "";
        uploadSection.style.display = "block";
        fileList.innerHTML = "";
        fileList.style.display = "none";
        pagesGrid.innerHTML = "";
        pagesGrid.style.display = "none";
        organizeBtn.style.display = "inline-flex";
        organizeBtn.disabled = false;
        resultBtns.style.display = "none";
        noteText.style.display = "block";
        organizeBtn.classList.remove("btn-loading");
        loaderIcon.style.display = "none";

        // Proper iframe cleanup
        pdfFrame.src = "";
        pdfPreview.style.display = "none";
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    </script>
  </body>
</html>
