<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Primary Meta Tags -->
    <title>
      PDF to PowerPoint Converter with OCR - Free Online Tool | NextoPDF
    </title>
    <meta
      name="title"
      content="PDF to PowerPoint Converter with OCR - Free Online Tool | NextoPDF"
    />
    <meta
      name="description"
      content="Convert PDF to PowerPoint (PPTX) with automatic OCR detection. Transform scanned PDFs into editable presentations. Supports 14+ languages. Free and secure."
    />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="./css/style.css" />

    <style>
      /* Enhanced Multi-select dropdown styles */
      .multi-select {
        position: relative;
        width: 100%;
        margin-top: 10px;
        margin-bottom: 20px;
      }

      .select-label {
        font-weight: 600;
        font-size: 16px;
        color: #1f2937;
        margin-bottom: 8px;
        display: block;
      }

      .select-box {
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 12px 14px;
        background: #fff;
        cursor: pointer;
        min-height: 48px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        transition: all 0.2s ease;
        position: relative;
      }

      .select-box:hover {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.05);
      }

      .select-box.open {
        border-color: #4f46e5;
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        background: #fafafa;
      }

      .select-box::after {
        content: "\f078";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
        transition: transform 0.2s ease;
        pointer-events: none;
      }

      .select-box.open::after {
        transform: translateY(-50%) rotate(180deg);
      }

      .select-placeholder {
        color: #9ca3af;
        font-size: 14px;
        user-select: none;
      }

      .tag {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        transition: all 0.2s ease;
      }

      .tag:hover {
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        transform: translateY(-1px);
      }

      .tag .remove-tag {
        cursor: pointer;
        font-size: 16px;
        opacity: 0.9;
        transition: opacity 0.2s;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
      }

      .tag .remove-tag:hover {
        opacity: 1;
        background: rgba(255, 255, 255, 0.3);
      }

      #dropdown {
        display: none;
        position: absolute;
        width: 100%;
        background: white;
        border: 2px solid #4f46e5;
        border-radius: 10px;
        max-height: 320px;
        overflow: hidden;
        z-index: 1000;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        margin-top: 6px;
        animation: dropdownSlide 0.2s ease;
      }

      @keyframes dropdownSlide {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      #dropdown.show {
        display: flex;
        flex-direction: column;
      }

      #dropdown input {
        width: calc(100% - 60px);
        margin: 12px 14px;
        padding: 10px 14px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      #dropdown input:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      #dropdown input::placeholder {
        color: #9ca3af;
      }

      #options {
        overflow-y: auto;
        max-height: 240px;
      }

      .option {
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.15s ease;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
      }

      .option:hover {
        background: #f3f4f6;
      }

      .option.selected {
        background: #ede9fe;
        color: #6d28d9;
        font-weight: 500;
      }

      .option.selected::after {
        content: "\f00c";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        color: #6d28d9;
        font-size: 12px;
      }

      /* File list styling */
      .file-list {
        list-style: none;
        padding: 0;
        margin: 20px 0;
      }

      .file-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 18px;
        background: #f9fafb;
        border-radius: 10px;
        margin-bottom: 10px;
        border: 2px solid #e5e7eb;
        transition: all 0.2s ease;
      }

      .file-list li:hover {
        border-color: #d1d5db;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .file-list li .pdf-icon {
        color: #ef4444;
        margin-right: 12px;
        font-size: 20px;
      }

      .file-info {
        display: flex;
        align-items: center;
        flex: 1;
      }

      .file-name-text {
        font-weight: 500;
        color: #1f2937;
      }

      .delete-file {
        background: #ef4444;
        border: none;
        color: white;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
      }

      .delete-file i {
        color: #fff;
      }

      .delete-file:hover,
      .delete-file:focus {
        background: #dc2626;
        transform: scale(1.1);
      }

      /* Loading state */
      .btn-loading {
        pointer-events: none;
        opacity: 0.7;
      }

      .btn-loading .btn-text {
        display: none;
      }

      .btn-spinner {
        display: none;
      }

      .btn-loading .btn-spinner {
        display: inline-block;
      }

      /* Enhanced Error messages */
      .error-text {
        color: #dc2626;
        font-size: 14px;
        margin-top: 12px;
        padding: 12px 16px;
        background: #fee2e2;
        border-left: 4px solid #dc2626;
        border-radius: 8px;
        display: none;
        animation: slideIn 0.3s ease;
      }

      .error-text::before {
        content: "\f06a";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        margin-right: 8px;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Note styling */
      .note {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
        padding: 14px 18px;
        border-radius: 8px;
        font-size: 14px;
        color: #1e40af;
        margin-top: 20px;
        line-height: 1.6;
      }

      .note i {
        margin-right: 8px;
      }

      /* Smooth scrollbar for dropdown */
      #options::-webkit-scrollbar {
        width: 8px;
      }

      #options::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      #options::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }

      #options::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* Result buttons container */
      .result-btns-container {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }

      @media (max-width: 768px) {
        .result-btns-container {
          flex-direction: column;
        }

        .result-btns-container .cta-button,
        .result-btns-container .secondary-btn {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <section id="header-placeholder"></section>

    <!-- Main Content -->
    <main id="main-content">
      <!-- PDF to PPT Tool Section -->
      <section class="merge-tool">
        <div class="container">
          <h1 id="ppt-heading">
            NextoPDF - PDF to PowerPoint Converter with OCR
          </h1>
          <p class="subtitle">
            Convert PDF to PowerPoint presentations with automatic OCR
            detection. Transform scanned PDFs into editable slides. Supports 14+
            languages. Fast, secure, and completely free.
          </p>

          <div class="upload-section">
            <div id="uploadSection">
              <label
                for="pdfUpload"
                class="upload-label"
                tabindex="0"
                role="button"
                aria-label="Choose PDF file to upload"
              >
                <i class="fa fa-upload" aria-hidden="true"></i>
                <span>Choose PDF File</span>
              </label>
              <input
                type="file"
                id="pdfUpload"
                accept=".pdf"
                aria-label="Select PDF file to convert to PowerPoint"
              />
            </div>

            <ul
              id="fileList"
              class="file-list"
              role="list"
              aria-label="Selected PDF file"
              style="display: none"
            ></ul>

            <!-- Language Selection -->
            <label class="select-label" for="selectBox" id="languageLabel">
              OCR Languages
              <span style="font-weight: 400; color: #6b7280; font-size: 14px">
                (For scanned PDFs - Select one or more)
              </span>
            </label>
            <div class="multi-select">
              <div
                class="select-box"
                id="selectBox"
                role="button"
                tabindex="0"
                aria-labelledby="languageLabel"
                aria-expanded="false"
                aria-haspopup="listbox"
              >
                <span class="tag">English</span>
              </div>
              <div id="dropdown" role="listbox" aria-labelledby="languageLabel">
                <input
                  type="text"
                  id="searchLang"
                  placeholder="Search language..."
                  aria-label="Search for languages"
                />
                <div id="options"></div>
              </div>
            </div>

            <button
              id="convertBtn"
              class="cta-button"
              aria-label="Convert PDF to PowerPoint"
            >
              <span class="btn-spinner" aria-hidden="true">
                <i class="fa fa-spinner fa-spin"></i>
                Processing...
              </span>
              <span class="btn-text">
                <i class="fa fa-file-powerpoint" aria-hidden="true"></i>
                Convert to PowerPoint
              </span>
            </button>

            <p
              class="error-text"
              id="errorMsg"
              role="alert"
              aria-live="polite"
            ></p>

            <!-- Result Section -->
            <div
              id="resultBtns"
              style="display: none; margin-top: 20px"
              role="region"
              aria-label="Conversion results"
            >
              <div id="resultCard" class="result-card">
                <i
                  class="fa fa-file-powerpoint"
                  aria-hidden="true"
                  style="font-size: 60px; color: white"
                ></i>
              </div>
              <p class="file-name">
                <a href="#" id="fileNameLink" aria-label="View converted PPTX"
                  >presentation.pptx</a
                >
              </p>

              <div class="result-btns-container">
                <a
                  id="downloadBtn"
                  href="#"
                  class="cta-button"
                  download="presentation.pptx"
                  aria-label="Download PowerPoint presentation"
                >
                  <i class="fa fa-download" aria-hidden="true"></i> Download
                </a>
                <button
                  id="shareBtn"
                  class="cta-button"
                  aria-label="Share PowerPoint presentation"
                >
                  <i class="fa fa-share-alt" aria-hidden="true"></i> Share
                </button>
                <button
                  id="resetBtn"
                  class="secondary-btn"
                  aria-label="Convert another PDF"
                >
                  <i class="fa fa-rotate-right" aria-hidden="true"></i> Convert
                  Another PDF
                </button>
              </div>
            </div>

            <p class="note">
              <i class="fa fa-info-circle" aria-hidden="true"></i>
              <strong>Smart Conversion:</strong> Text-based PDFs will have
              selectable text in PowerPoint. Scanned/image-based PDFs will be
              converted to images with OCR text in speaker notes. Select
              multiple languages if your document contains text in different
              languages.
            </p>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <section id="footer-placeholder"></section>

    <!-- JS -->
    <script src="./js/app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      const BACKEND_URL = `http://127.0.0.1:8080/pdf-to-ppt`;
      const CHECK_TEXT_URL = `http://127.0.0.1:8080/check-pdf-text`;
      const MAX_FILE_SIZE = 50 * 1024 * 1024;

      const pdfInput = document.getElementById("pdfUpload");
      const fileList = document.getElementById("fileList");
      const convertBtn = document.getElementById("convertBtn");
      const errorMsg = document.getElementById("errorMsg");
      const resultBtns = document.getElementById("resultBtns");
      const downloadBtn = document.getElementById("downloadBtn");
      const shareBtn = document.getElementById("shareBtn");
      const resetBtn = document.getElementById("resetBtn");
      const fileNameLink = document.getElementById("fileNameLink");
      const uploadSection = document.getElementById("uploadSection");

      // ============================================================================
      // STATE
      // ============================================================================

      let selectedFile = null;
      let convertedFileUrl = null;
      let convertedFileName = "presentation.pptx";
      let isConverting = false;

      // ============================================================================
      // LANGUAGE SELECTION
      // ============================================================================

      // Language options [code, name]
      const languages = [
        ["eng", "English"],
        ["hin", "Hindi"],
        ["ben", "Bengali"],
        ["spa", "Spanish"],
        ["fra", "French"],
        ["deu", "German"],
        ["ita", "Italian"],
        ["por", "Portuguese"],
        ["rus", "Russian"],
        ["jpn", "Japanese"],
        ["kor", "Korean"],
        ["chi_sim", "Chinese Simplified"],
        ["chi_tra", "Chinese Traditional"],
        ["ara", "Arabic"],
        ["tha", "Thai"],
        ["vie", "Vietnamese"],
      ];

      let selectedLangs = ["eng"];

      // Multi-select dropdown elements
      const selectBox = document.getElementById("selectBox");
      const dropdown = document.getElementById("dropdown");
      const optionsDiv = document.getElementById("options");
      const searchInput = document.getElementById("searchLang");

      // Render language options
      function renderOptions(filter = "") {
        optionsDiv.innerHTML = "";
        const filteredLangs = languages.filter((l) =>
          l[1].toLowerCase().includes(filter.toLowerCase()),
        );

        if (filteredLangs.length === 0) {
          optionsDiv.innerHTML =
            '<div style="padding: 20px; text-align: center; color: #9ca3af;">No languages found</div>';
          return;
        }

        filteredLangs.forEach((l) => {
          const div = document.createElement("div");
          div.className =
            "option" + (selectedLangs.includes(l[0]) ? " selected" : "");
          div.textContent = l[1];
          div.setAttribute("role", "option");
          div.setAttribute(
            "aria-selected",
            selectedLangs.includes(l[0]) ? "true" : "false",
          );
          div.onclick = () => toggleLang(l);
          optionsDiv.appendChild(div);
        });
      }

      // Toggle language selection
      function toggleLang(l) {
        hideError();
        if (selectedLangs.includes(l[0])) {
          selectedLangs = selectedLangs.filter((x) => x !== l[0]);
        } else {
          selectedLangs.push(l[0]);
        }
        updateTags();
        renderOptions(searchInput.value);
      }

      // Update selected language tags
      function updateTags() {
        selectBox.innerHTML = "";
        if (selectedLangs.length === 0) {
          selectBox.innerHTML =
            '<span class="select-placeholder">Select languages...</span>';
          return;
        }
        selectedLangs.forEach((code) => {
          const name = languages.find((l) => l[0] === code)[1];
          const tag = document.createElement("span");
          tag.className = "tag";
          tag.innerHTML = `${name} <span class="remove-tag" data-code="${code}" role="button" aria-label="Remove ${name}" tabindex="0">×</span>`;
          selectBox.appendChild(tag);
        });

        // Add click handlers for remove buttons
        selectBox.querySelectorAll(".remove-tag").forEach((btn) => {
          btn.onclick = (e) => {
            e.stopPropagation();
            const code = e.target.dataset.code;
            selectedLangs = selectedLangs.filter((x) => x !== code);
            updateTags();
            renderOptions(searchInput.value);
          };

          // Keyboard support for remove buttons
          btn.onkeypress = (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              e.stopPropagation();
              const code = e.target.dataset.code;
              selectedLangs = selectedLangs.filter((x) => x !== code);
              updateTags();
              renderOptions(searchInput.value);
            }
          };
        });
      }

      // Toggle dropdown
      selectBox.onclick = (e) => {
        // Don't toggle if clicking on remove button
        if (e.target.classList.contains("remove-tag")) return;

        const isOpen = dropdown.classList.contains("show");
        dropdown.classList.toggle("show");
        selectBox.classList.toggle("open");
        selectBox.setAttribute("aria-expanded", !isOpen);

        if (!isOpen) {
          searchInput.focus();
          searchInput.value = "";
          renderOptions();
        }
      };

      // Search functionality
      searchInput.oninput = (e) => renderOptions(e.target.value);

      // Close dropdown when clicking outside
      document.addEventListener("click", (e) => {
        if (!selectBox.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.remove("show");
          selectBox.classList.remove("open");
          selectBox.setAttribute("aria-expanded", "false");
        }
      });

      // Keyboard accessibility for select box
      selectBox.addEventListener("keypress", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          selectBox.click();
        }
      });

      // Initialize
      renderOptions();
      updateTags();

      // ============================================================================
      // UTILITY FUNCTIONS
      // ============================================================================

      function hideError() {
        errorMsg.style.display = "none";
        errorMsg.textContent = "";
      }

      function showError(message) {
        errorMsg.textContent = message;
        errorMsg.style.display = "block";

        // Auto hide after 7 seconds
        setTimeout(() => {
          if (errorMsg.textContent === message) {
            errorMsg.style.display = "none";
          }
        }, 7000);
      }

      function showSuccess(message) {
        // Create success message element if it doesn't exist
        let successMsg = document.getElementById("successMsg");
        if (!successMsg) {
          successMsg = document.createElement("div");
          successMsg.id = "successMsg";
          successMsg.className = "success-message";
          successMsg.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        z-index: 10000;
        animation: slideInRight 0.3s ease;
        font-weight: 500;
      `;
          document.body.appendChild(successMsg);
        }

        successMsg.innerHTML = `<i class="fa fa-check-circle" aria-hidden="true" style="margin-right: 8px;"></i>${message}`;
        successMsg.style.display = "block";

        // Auto hide after 4 seconds
        setTimeout(() => {
          successMsg.style.display = "none";
        }, 4000);
      }

      // ============================================================================
      // FILE HANDLING
      // ============================================================================

      function renderFileList() {
        if (!selectedFile) {
          fileList.style.display = "none";
          return;
        }
        fileList.style.display = "block";
        fileList.innerHTML = "";

        const li = document.createElement("li");
        const fileSizeMB = (selectedFile.size / (1024 * 1024)).toFixed(2);
        li.innerHTML = `
      <div class="file-info">
        <i class="fa fa-file-pdf pdf-icon" aria-hidden="true"></i>
        <span class="file-name-text">${selectedFile.name}</span>
        <span style="color: #6b7280; font-size: 13px; margin-left: 8px;">(${fileSizeMB} MB)</span>
      </div>
      <button class="delete-file" onclick="removeFile()" aria-label="Remove ${selectedFile.name}">
        <i class="fa fa-times" aria-hidden="true"></i>
      </button>
    `;
        fileList.appendChild(li);
      }

      // File input change handler
      pdfInput.addEventListener("change", (e) => {
        console.log("File input changed");
        hideError();

        if (pdfInput.files && pdfInput.files.length > 0) {
          const file = pdfInput.files[0];
          console.log("File selected:", file.name, file.size, file.type);

          // Validate file type
          if (
            file.type !== "application/pdf" &&
            !file.name.toLowerCase().endsWith(".pdf")
          ) {
            console.error("Invalid file type:", file.type);
            showError("Please select a valid PDF file");
            pdfInput.value = "";
            selectedFile = null;
            renderFileList();
            return;
          }

          // Validate file size
          if (file.size > MAX_FILE_SIZE) {
            console.error("File too large:", file.size);
            showError(
              `File size exceeds ${(MAX_FILE_SIZE / (1024 * 1024)).toFixed(0)}MB limit`,
            );
            pdfInput.value = "";
            selectedFile = null;
            renderFileList();
            return;
          }

          // Validate file is not empty
          if (file.size === 0) {
            console.error("File is empty");
            showError("Selected file is empty. Please choose a valid PDF.");
            pdfInput.value = "";
            selectedFile = null;
            renderFileList();
            return;
          }

          selectedFile = file;
          console.log("File successfully set:", selectedFile);
          renderFileList();
          showSuccess(`File "${file.name}" selected successfully!`);
        } else {
          console.log("No file selected");
          selectedFile = null;
          renderFileList();
        }
      });

      // Delete file
      window.removeFile = function () {
        selectedFile = null;
        pdfInput.value = "";
        renderFileList();
        hideError();
      };

      async function checkPDFHasText(file) {
        const formData = new FormData();
        formData.append("file", file);

        try {
          console.log("Checking if PDF has text...");
          const response = await fetch(CHECK_TEXT_URL, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error(
              "Check text response not OK:",
              response.status,
              errorData,
            );
            throw new Error(errorData.error || "Failed to check PDF text");
          }

          const result = await response.json();
          console.log("PDF text check result:", result);
          console.log(
            `  - hasText: ${result.hasText} (${result.hasText ? "TEXT-BASED PDF" : "IMAGE-BASED PDF"})`,
          );
          console.log(`  - Reason: ${result.reason || "N/A"}`);

          // Return the hasText value from the server
          // true = TEXT-BASED PDF (has selectable text)
          // false = IMAGE-BASED PDF (scanned/images)
          return result.hasText;
        } catch (error) {
          console.error("Error checking PDF:", error);
          // If check fails, assume it might be image-based to be safe
          console.warn("Defaulting to image-based due to check failure");
          return false;
        }
      }

      function showOCRChoiceDialog() {
        return new Promise((resolve) => {
          // Remove existing dialog if any
          const existingDialog = document.getElementById("ocrChoiceDialog");
          if (existingDialog) {
            existingDialog.remove();
          }

          // Remove existing styles if any
          const existingStyle = document.getElementById("ocrDialogStyle");
          if (existingStyle) {
            existingStyle.remove();
          }

          // Create dialog
          const dialog = document.createElement("div");
          dialog.id = "ocrChoiceDialog";
          dialog.className = "ocr-dialog";
          dialog.innerHTML = `
      <div class="ocr-dialog-content">
        <h3><i class="fa fa-search" aria-hidden="true" style="margin-right: 10px; color: #667eea;"></i>OCR Detection Required</h3>
        <p>Your PDF appears to be image-based (scanned document or images).</p>
        <p class="dialog-subtitle">Choose how to process:</p>
        <div class="ocr-dialog-options">
          <button id="ocrOption" class="cta-button">
            <i class="fa fa-magic" aria-hidden="true" style="font-size: 24px; margin-bottom: 8px;"></i>
            <span class="option-title">OCR Processing</span>
            <span class="option-desc">Extract text from images - text will be editable and searchable in PowerPoint (slower but better)</span>
          </button>
          <button id="imageOption" class="secondary-btn">
            <i class="fa fa-image" aria-hidden="true" style="font-size: 24px; margin-bottom: 8px;"></i>
            <span class="option-title">Image-Only</span>
            <span class="option-desc">Convert as images without OCR - faster but text won't be selectable</span>
          </button>
        </div>
        <button id="cancelOption" class="text-btn">
          <i class="fa fa-times" aria-hidden="true"></i> Cancel
        </button>
      </div>
    `;

          // Add styles
          const style = document.createElement("style");
          style.id = "ocrDialogStyle";
          style.textContent = `
      .ocr-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        animation: fadeIn 0.3s ease;
        backdrop-filter: blur(5px);
      }
      
      .ocr-dialog-content {
        background: white;
        border-radius: 24px;
        padding: 35px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
      }
      
      .ocr-dialog-content h3 {
        color: #1f2937;
        margin-bottom: 15px;
        font-size: 24px;
        display: flex;
        align-items: center;
      }
      
      .ocr-dialog-content p {
        color: #4b5563;
        margin-bottom: 10px;
        line-height: 1.6;
        font-size: 16px;
      }
      
      .dialog-subtitle {
        font-weight: 600;
        color: #374151;
        margin-top: 20px;
        margin-bottom: 15px;
      }
      
      .ocr-dialog-options {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin: 20px 0;
      }
      
      .ocr-dialog-options button {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 25px 20px;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        width: 100%;
        text-align: center;
      }
      
      .option-title {
        font-size: 18px;
        font-weight: 700;
        margin: 8px 0 5px;
      }
      
      .ocr-dialog-options button .option-desc {
        font-size: 14px;
        opacity: 0.9;
        color: inherit;
        line-height: 1.5;
      }
      
      .ocr-dialog-options .cta-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
      }
      
      .ocr-dialog-options .cta-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
      }
      
      .ocr-dialog-options .secondary-btn {
        background: white;
        color: #4b5563;
        border: 2px solid #e5e7eb;
      }
      
      .ocr-dialog-options .secondary-btn:hover {
        border-color: #667eea;
        background: #f9fafb;
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
      
      .text-btn {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
        padding: 12px;
        transition: all 0.2s ease;
        border-radius: 8px;
        margin-top: 10px;
      }
      
      .text-btn:hover {
        color: #ef4444;
        background: #fef2f2;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      @keyframes slideUp {
        from { 
          opacity: 0;
          transform: translateY(30px);
        }
        to { 
          opacity: 1;
          transform: translateY(0);
        }
      }
    `;

          document.head.appendChild(style);
          document.body.appendChild(dialog);

          // Handle button clicks
          document.getElementById("ocrOption").onclick = () => {
            dialog.remove();
            style.remove();
            resolve("ocr");
          };

          document.getElementById("imageOption").onclick = () => {
            dialog.remove();
            style.remove();
            resolve("image");
          };

          document.getElementById("cancelOption").onclick = () => {
            dialog.remove();
            style.remove();
            resolve("cancel");
          };

          // Close on escape key
          const escHandler = (e) => {
            if (e.key === "Escape") {
              dialog.remove();
              style.remove();
              document.removeEventListener("keydown", escHandler);
              resolve("cancel");
            }
          };
          document.addEventListener("keydown", escHandler);
        });
      }

      function showProcessingDialog(pageCount = null) {
        const dialog = document.createElement("div");
        dialog.id = "processingDialog";
        dialog.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(5px);
    `;

        const content = `
      <div style="
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
      ">
        <div style="
          width: 80px;
          height: 80px;
          border: 4px solid #f3f4f6;
          border-top: 4px solid #667eea;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin: 0 auto 20px;
        "></div>
        <h3 style="color: #1f2937; margin-bottom: 10px; font-size: 22px;">
          Converting PDF to PowerPoint
        </h3>
        <p style="color: #6b7280; margin-bottom: 15px; font-size: 15px;">
          ${pageCount ? `Processing ${pageCount} page${pageCount > 1 ? "s" : ""}...` : "Processing..."}
        </p>
        <p style="color: #9ca3af; font-size: 13px;">
          This may take a moment. Please don't close this page.
        </p>
      </div>
    `;

        dialog.innerHTML = content;

        // Add animation style
        const style = document.createElement("style");
        style.textContent = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;
        document.head.appendChild(style);
        document.body.appendChild(dialog);

        return dialog;
      }

      function hideProcessingDialog() {
        const dialog = document.getElementById("processingDialog");
        if (dialog) {
          dialog.remove();
        }
      }

      convertBtn.addEventListener("click", async () => {
        console.log("\n=== CONVERSION STARTED ===");
        console.log("Selected file:", selectedFile?.name);
        console.log("Selected languages:", selectedLangs);

        if (isConverting) {
          showError("Conversion already in progress. Please wait.");
          return;
        }

        if (!selectedFile) {
          showError("Please upload a PDF file");
          return;
        }

        if (selectedLangs.length === 0) {
          showError("Please select at least one language for OCR");
          return;
        }

        hideError();
        isConverting = true;
        convertBtn.classList.add("btn-loading");
        convertBtn.disabled = true;

        let processingDialog = null;

        try {
          // STEP 1: Check if PDF has text
          console.log("\nSTEP 1: Checking PDF type...");
          const hasText = await checkPDFHasText(selectedFile);

          let conversionMode = "auto";
          let finalHasText = hasText;

          // STEP 2: Decide whether to show dialog
          if (hasText) {
            // TEXT-BASED PDF - Convert directly without dialog
            console.log("\nSTEP 2: TEXT-BASED PDF detected");
            console.log("  → Converting directly without showing dialog");
            conversionMode = "auto";
            finalHasText = true;
          } else {
            // IMAGE-BASED PDF - Show dialog to user
            console.log("\nSTEP 2: IMAGE-BASED PDF detected");
            console.log(
              "  → Showing dialog for user to choose processing method",
            );

            const choice = await showOCRChoiceDialog();
            console.log("  → User selected:", choice);

            if (choice === "cancel") {
              console.log("  → User cancelled conversion");
              isConverting = false;
              convertBtn.classList.remove("btn-loading");
              convertBtn.disabled = false;
              return;
            }

            conversionMode = choice; // 'ocr' or 'image'
            finalHasText = false;
          }

          // STEP 3: Show processing dialog
          console.log("\nSTEP 3: Starting conversion...");
          console.log(`  → Mode: ${conversionMode}`);
          console.log(`  → Has Text: ${finalHasText}`);
          processingDialog = showProcessingDialog();

          // STEP 4: Prepare and send request
          const formData = new FormData();
          formData.append("file", selectedFile);
          formData.append("lang", selectedLangs.join("+"));
          formData.append("mode", conversionMode);
          formData.append("has_text", finalHasText.toString());

          console.log("\nSTEP 4: Sending to backend...");
          const res = await fetch(BACKEND_URL, {
            method: "POST",
            body: formData,
          });

          if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            throw new Error(
              errorData.error || `Conversion failed (Status: ${res.status})`,
            );
          }

          const blob = await res.blob();

          if (blob.size === 0) {
            throw new Error("Received empty file from server");
          }

          const url = URL.createObjectURL(blob);
          convertedFileUrl = url;

          const baseName = selectedFile.name.replace(/\.pdf$/i, "");
          const filename = `${baseName}.pptx`;
          convertedFileName = filename;

          console.log("\n✓ CONVERSION SUCCESSFUL");

          // Update UI
          fileList.style.display = "none";
          convertBtn.style.display = "none";
          uploadSection.style.display = "none";
          document.querySelector(".note").style.display = "none";
          document.querySelector(".multi-select").style.display = "none";
          document.querySelector(".select-label").style.display = "none";
          resultBtns.style.display = "block";

          downloadBtn.href = url;
          downloadBtn.download = filename;
          fileNameLink.textContent = filename;
          fileNameLink.onclick = (e) => {
            e.preventDefault();
            window.open(url, "_blank");
          };

          // Show success message
          if (!hasText && conversionMode === "ocr") {
            showSuccess(
              "Image-based PDF processed with OCR! Text is now editable.",
            );
          } else if (!hasText && conversionMode === "image") {
            showSuccess("Image-based PDF converted as images successfully!");
          } else {
            showSuccess("Text-based PDF converted successfully!");
          }
        } catch (err) {
          console.error("\n✗ CONVERSION FAILED:", err);
          showError(err.message || "Conversion failed. Please try again.");
        } finally {
          if (processingDialog) {
            processingDialog.remove();
          }
          isConverting = false;
          convertBtn.classList.remove("btn-loading");
          convertBtn.disabled = false;
          console.log("=== CONVERSION ENDED ===\n");
        }
      });

      shareBtn.addEventListener("click", async () => {
        if (!convertedFileUrl) return;

        try {
          // Check if Web Share API is supported
          if (navigator.share && navigator.canShare) {
            // Convert blob URL to File object for sharing
            const response = await fetch(convertedFileUrl);
            const blob = await response.blob();
            const file = new File([blob], convertedFileName, {
              type: "application/vnd.openxmlformats-officedocument.presentationml.presentation",
            });

            const shareData = {
              title: "PowerPoint Presentation",
              text: "Check out this PowerPoint presentation",
              files: [file],
            };

            if (navigator.canShare(shareData)) {
              await navigator.share(shareData);
              showSuccess("File shared successfully!");
            } else {
              // Fallback: share without file
              await navigator.share({
                title: "PowerPoint Presentation",
                text: `I converted a PDF to PowerPoint`,
                url: window.location.href,
              });
            }
          } else {
            // Fallback for browsers that don't support Web Share API
            const tempInput = document.createElement("input");
            tempInput.value = window.location.href;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);

            // Show temporary notification
            const originalText = shareBtn.innerHTML;
            shareBtn.innerHTML =
              '<i class="fa fa-check" aria-hidden="true"></i> Link Copied!';
            shareBtn.disabled = true;
            setTimeout(() => {
              shareBtn.innerHTML = originalText;
              shareBtn.disabled = false;
            }, 2000);

            showSuccess("Download link copied to clipboard!");
          }
        } catch (error) {
          // User cancelled share or error occurred
          if (error.name !== "AbortError") {
            console.log("Share failed:", error);
            showError("Sharing failed. You can still download the file.");
          }
        }
      });

      // ============================================================================
      // RESET FUNCTIONALITY
      // ============================================================================

      resetBtn.addEventListener("click", () => {
        // Clean up blob URL
        if (convertedFileUrl) {
          URL.revokeObjectURL(convertedFileUrl);
        }

        selectedFile = null;
        selectedLangs = ["eng"];
        convertedFileUrl = null;
        convertedFileName = "presentation.pptx";
        isConverting = false;
        pdfInput.value = "";
        fileList.innerHTML = "";
        fileList.style.display = "none";
        uploadSection.style.display = "block";
        convertBtn.style.display = "inline-flex";
        convertBtn.classList.remove("btn-loading");
        convertBtn.disabled = false;
        resultBtns.style.display = "none";
        document.querySelector(".note").style.display = "block";
        document.querySelector(".multi-select").style.display = "block";
        document.querySelector(".select-label").style.display = "block";
        hideError();
        updateTags();
        renderOptions();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      // ============================================================================
      // DRAG AND DROP
      // ============================================================================

      const uploadLabel = document.querySelector(".upload-label");

      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        uploadLabel.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ["dragenter", "dragover"].forEach((eventName) => {
        uploadLabel.addEventListener(eventName, highlight, false);
      });

      ["dragleave", "drop"].forEach((eventName) => {
        uploadLabel.addEventListener(eventName, unhighlight, false);
      });

      function highlight() {
        uploadLabel.classList.add("drag-over");
        uploadLabel.style.transform = "scale(1.02)";
        uploadLabel.style.borderColor = "#4f46e5";
        uploadLabel.style.backgroundColor = "#f5f3ff";
      }

      function unhighlight() {
        uploadLabel.classList.remove("drag-over");
        uploadLabel.style.transform = "scale(1)";
        uploadLabel.style.borderColor = "";
        uploadLabel.style.backgroundColor = "";
      }

      uploadLabel.addEventListener("drop", (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
          const file = files[0];
          if (file.type === "application/pdf") {
            // Check file size
            if (file.size > MAX_FILE_SIZE) {
              showError(
                `File size exceeds ${MAX_FILE_SIZE / (1024 * 1024)}MB limit`,
              );
              return;
            }
            selectedFile = file;
            // Create a new FileList-like object
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            pdfInput.files = dataTransfer.files;
            renderFileList();
            showSuccess(`File "${file.name}" selected successfully!`);
          } else {
            showError("Please drop a PDF file");
          }
        }
      });

      // ============================================================================
      // KEYBOARD SHORTCUTS
      // ============================================================================

      // Keyboard accessibility for upload label
      document
        .querySelector(".upload-label")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            pdfInput.click();
          }
        });

      // Ctrl/Cmd + Enter to convert
      document.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
          if (
            selectedFile &&
            !isConverting &&
            convertBtn.style.display !== "none"
          ) {
            convertBtn.click();
          }
        }
      });

      // ============================================================================
      // CLEANUP
      // ============================================================================

      // Clean up blob URL when page unloads
      window.addEventListener("beforeunload", () => {
        if (convertedFileUrl) {
          URL.revokeObjectURL(convertedFileUrl);
        }
      });

      // ============================================================================
      // INITIALIZATION LOG
      // ============================================================================

      console.log("PDF to PowerPoint converter initialized");
      console.log("Backend URL:", BACKEND_URL);
      console.log("Check text URL:", CHECK_TEXT_URL);
    </script>
  </body>
</html>
