<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Primary Meta Tags -->
    <title>
      Remove Watermark from PDF Online Free - Fast & Easy | NextoPDF
    </title>
    <meta
      name="title"
      content="Remove Watermark from PDF Online Free - Fast & Easy | NextoPDF"
    />
    <meta
      name="description"
      content="Remove watermarks from PDF files online for free. Click and select text or image watermarks to delete permanently. Uses PyMuPDF for accurate detection and removal."
    />
    <meta
      name="keywords"
      content="remove watermark from PDF, delete watermark PDF, PDF watermark remover free, remove text watermark, remove image watermark, clean PDF, unwatermark PDF"
    />
    <meta name="author" content="NextoPDF" />
    <meta
      name="robots"
      content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"
    />

    <!-- Canonical URL -->
    <link rel="canonical" href="https://nextopdf.com/remove-watermark" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://nextopdf.com/remove-watermark" />
    <meta
      property="og:title"
      content="Remove Watermark from PDF Online Free - Fast & Easy | NextoPDF"
    />
    <meta
      property="og:description"
      content="Remove watermarks from PDF files online for free. Click and select text or image watermarks to delete permanently."
    />
    <meta
      property="og:image"
      content="https://nextopdf.com/images/og-image.png"
    />
    <meta property="og:site_name" content="NextoPDF" />
    <meta property="og:locale" content="en_US" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://nextopdf.com/remove-watermark" />
    <meta
      name="twitter:title"
      content="Remove Watermark from PDF Online Free - Fast & Easy | NextoPDF"
    />
    <meta
      name="twitter:description"
      content="Remove watermarks from PDF files online for free. Click and select text or image watermarks to delete permanently."
    />
    <meta
      name="twitter:image"
      content="https://nextopdf.com/images/twitter-card.png"
    />
    <meta name="google-adsense-account" content="ca-pub-5797619165090350" />

    <!-- Structured Data / Schema.org -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "NextoPDF - Remove Watermark from PDF",
        "url": "https://nextopdf.com/remove-watermark",
        "description": "Free online tool to remove text and image watermarks from PDF documents with accurate detection and permanent deletion",
        "applicationCategory": "UtilitiesApplication",
        "operatingSystem": "Any",
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "USD"
        },
        "featureList": "Remove text watermarks, Remove image watermarks, Batch processing, Visual selection, Permanent deletion, PyMuPDF powered"
      }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Inter:wght@400;500&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Main CSS -->
    <link rel="stylesheet" href="./css/style.css" />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./images/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="./images/favicon-16x16.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="./images/apple-touch-icon.png"
    />

    <!-- Google AdSense -->
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5797619165090350"
      crossorigin="anonymous"
    ></script>

    <style>
      .pages-grid {
        display: flex;
        flex-direction: column;
        gap: 30px;
        margin-top: 20px;
        align-items: center;
      }

      .page-card {
        position: relative;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        width: fit-content;
        max-width: 100%;
        transition: all 0.3s ease;
      }

      @media (max-width: 768px) {
        .page-card {
          padding: 15px;
        }
      }

      .page-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .page-canvas-container {
        position: relative;
        display: inline-block;
        line-height: 0;
      }

      .page-card canvas {
        display: block;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        max-width: 100% !important;
        height: auto !important;
      }

      .page-number-badge {
        position: absolute;
        top: -8px;
        left: 8px;
        background: #4f46e5;
        color: white;
        padding: 6px 12px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
        z-index: 5;
      }

      @media (max-width: 768px) {
        .page-number-badge {
          font-size: 12px;
          padding: 5px 10px;
        }
      }

      .watermark-overlay {
        position: absolute;
        cursor: pointer;
        user-select: none;
        z-index: 10;
        transition: all 0.2s ease;
        box-sizing: border-box;
        pointer-events: auto;
      }

      .watermark-overlay.type-text,
      .watermark-overlay.type-image {
        background: rgba(239, 68, 68, 0.15);
        outline: 2px solid rgba(239, 68, 68, 0.3);
        outline-offset: -2px;
      }

      .watermark-overlay.type-text:hover,
      .watermark-overlay.type-image:hover {
        outline-color: #ef4444 !important;
        background: rgba(239, 68, 68, 0.25) !important;
        z-index: 90;
      }

      .watermark-overlay.selected {
        outline-color: #ef4444 !important;
        background: rgba(239, 68, 68, 0.3) !important;
        outline-style: solid !important;
        outline-width: 3px !important;
        z-index: 99;
      }

      .watermark-overlay.deleted {
        display: none;
      }

      .overlay-label {
        position: absolute;
        top: -22px;
        left: 0;
        background: #1e40af;
        color: white;
        padding: 9px 4px;
        font-size: 11px;
        border-radius: 4px;
        white-space: nowrap;
        display: none;
        z-index: 30;
        max-width: 250px;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
      }

      @media (max-width: 768px) {
        .overlay-label {
          font-size: 10px;
          padding: 6px 6px;
          max-width: 200px;
          top: -14px;
        }
      }

      @media (max-width: 480px) {
        .overlay-label {
          font-size: 9px;
          padding: 5px 5px;
          max-width: 150px;
          top: -12px;
        }
      }

      .watermark-overlay:hover .overlay-label {
        display: block;
      }

      .delete-icon {
        position: absolute;
        top: -10px;
        right: -10px;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        z-index: 20;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        flex-shrink: 0;
      }

      @media (max-width: 768px) {
        .delete-icon {
          width: 20px;
          height: 20px;
          font-size: 10px;
          top: -8px;
          right: -8px;
        }
      }

      @media (max-width: 480px) {
        .delete-icon {
          width: 18px;
          height: 18px;
          font-size: 9px;
          top: -6px;
          right: -6px;
        }
      }

      .delete-icon i {
        font-size: inherit;
      }

      .watermark-overlay.selected .delete-icon {
        display: flex;
      }

      .delete-icon:hover {
        background: #dc2626;
        transform: scale(1.1);
      }

      #controlPanel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 3px solid #ef4444;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        padding: 15px;
        display: none;
        z-index: 999;
      }

      @media (max-width: 768px) {
        #controlPanel {
          padding: 12px 10px;
        }
      }

      #controlPanel.show {
        display: block;
      }

      .control-content {
        max-width: 1200px;
        margin: 0 auto;
        text-align: center;
      }

      .selection-info {
        font-size: 15px;
        color: #1e3a8a;
        margin-bottom: 12px;
        font-weight: 600;
      }

      @media (max-width: 768px) {
        .selection-info {
          font-size: 14px;
          margin-bottom: 10px;
        }
      }

      @media (max-width: 480px) {
        .selection-info {
          font-size: 13px;
        }
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      @media (max-width: 768px) {
        .action-buttons {
          gap: 8px;
        }
      }

      .action-buttons button {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      @media (max-width: 768px) {
        .action-buttons button {
          padding: 10px 18px;
          font-size: 13px;
        }
      }

      @media (max-width: 480px) {
        .action-buttons button {
          padding: 10px 16px;
          font-size: 12px;
        }

        .action-buttons button i {
          font-size: 11px;
        }
      }

      .note-box {
        background: #f0f9ff;
        border-left: 4px solid #3b82f6;
        padding: 14px 18px;
        margin-top: 15px;
        font-size: 14px;
        border-radius: 4px;
        line-height: 1.6;
      }

      @media (max-width: 768px) {
        .note-box {
          font-size: 13px;
          padding: 12px 14px;
        }
      }

      @media (max-width: 480px) {
        .note-box {
          font-size: 12px;
          padding: 10px 12px;
        }
      }

      .success-message {
        background: #d1fae5;
        border-left: 4px solid #059669;
        padding: 14px 18px;
        margin-top: 15px;
        font-size: 14px;
        border-radius: 4px;
        color: #065f46;
        display: none;
        line-height: 1.6;
      }

      @media (max-width: 768px) {
        .success-message {
          font-size: 13px;
          padding: 12px 14px;
        }
      }

      @media (max-width: 480px) {
        .success-message {
          font-size: 12px;
          padding: 10px 12px;
        }
      }

      .success-message.show {
        display: block;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .loading-overlay.show {
        display: flex;
      }

      .loading-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        max-width: 90%;
      }

      @media (max-width: 768px) {
        .loading-content {
          padding: 24px;
        }

        .loading-content p {
          font-size: 14px;
        }
      }

      @media (max-width: 480px) {
        .loading-content {
          padding: 20px;
        }

        .loading-content p {
          font-size: 13px;
        }
      }

      .spinner {
        border: 4px solid #f3f4f6;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .file-list {
        display: none;
        list-style: none;
        padding: 0;
        margin: 20px 0;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }

      .file-list li {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s ease;
      }

      @media (max-width: 768px) {
        .file-list li {
          padding: 10px 12px;
          gap: 10px;
        }
      }

      .file-list li:hover {
        border-color: #4f46e5;
        transform: translateX(4px);
      }

      .pdf-icon {
        color: #ef4444;
        font-size: 20px;
      }

      @media (max-width: 768px) {
        .pdf-icon {
          font-size: 18px;
        }
      }

      .file-list li span {
        flex: 1;
        color: #1f2937;
        font-weight: 500;
        font-size: 14px;
        word-break: break-word;
      }

      @media (max-width: 768px) {
        .file-list li span {
          font-size: 13px;
        }
      }

      @media (max-width: 480px) {
        .file-list li span {
          font-size: 12px;
        }
      }

      .delete-file {
        background: #ef4444;
        border: none;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease;
        flex-shrink: 0;
      }
      .delete-file i {
        color: #fff;
      }
      .delete-file:hover {
        background: #dc2626;
      }

      .merge-tool h1 {
        font-size: 2rem;
      }

      @media (max-width: 768px) {
        .merge-tool h1 {
          font-size: 1.5rem;
        }
      }

      @media (max-width: 480px) {
        .merge-tool h1 {
          font-size: 1.3rem;
        }
      }

      .merge-tool p {
        font-size: 1rem;
      }

      @media (max-width: 768px) {
        .merge-tool p {
          font-size: 0.9rem;
        }
      }

      @media (max-width: 480px) {
        .merge-tool p {
          font-size: 0.85rem;
        }
      }

      .error-text {
        background: #fee2e2;
        border-left: 4px solid #ef4444;
        padding: 12px 16px;
        font-size: 14px;
        border-radius: 4px;
        color: #991b1b;
        line-height: 1.6;
      }

      @media (max-width: 768px) {
        .error-text {
          font-size: 13px;
          padding: 10px 14px;
        }
      }

      @media (max-width: 480px) {
        .error-text {
          font-size: 12px;
          padding: 10px 12px;
        }
      }
    </style>
  </head>

  <body>
    <section id="header-placeholder"></section>

    <main role="main">
      <section class="merge-tool">
        <div class="container">
          <h1>NextoPDF - Remove Watermark from PDF Online Free</h1>
          <p>
            NextoPDF - Upload your PDF and click on any text or image to select
            watermarks for removal. Uses PyMuPDF for accurate detection and
            permanent deletion.
          </p>

          <div class="upload-section">
            <div id="uploadSection">
              <label class="upload-label" for="pdfUpload">
                <i class="fa fa-upload" aria-hidden="true"></i> Choose PDF file
              </label>
              <input
                type="file"
                id="pdfUpload"
                accept=".pdf"
                aria-label="Upload PDF file to remove watermarks"
              />
            </div>

            <ul id="fileList" class="file-list" role="list"></ul>

            <div
              class="success-message"
              id="successMsg"
              role="status"
              aria-live="polite"
            ></div>
            <div
              id="pagesGrid"
              class="pages-grid"
              style="display: none"
              role="region"
              aria-label="PDF pages with selectable watermarks"
            ></div>

            <div
              id="controlPanel"
              role="region"
              aria-label="Watermark removal controls"
            >
              <div class="control-content">
                <p
                  class="error-text"
                  id="errorMsg"
                  style="display: none; margin-bottom: 10px"
                  role="alert"
                  aria-live="assertive"
                ></p>
                <div
                  class="selection-info"
                  id="selectionInfo"
                  aria-live="polite"
                >
                  No items selected
                </div>
                <div class="action-buttons">
                  <button
                    id="clearBtn"
                    class="secondary-btn"
                    aria-label="Clear all selected watermarks"
                  >
                    <i class="fa fa-times" aria-hidden="true"></i> Clear
                    Selection
                  </button>
                  <button
                    id="deleteBtn"
                    class="cta-button"
                    style="background: #f59e0b"
                    aria-label="Delete selected watermarks"
                  >
                    <i class="fa fa-trash" aria-hidden="true"></i> Delete
                    Selected
                  </button>
                  <button
                    id="removeBtn"
                    class="cta-button"
                    aria-label="Save changes and download cleaned PDF"
                  >
                    <i class="fa fa-save" aria-hidden="true"></i> Save Changes
                  </button>
                </div>
              </div>
            </div>

            <div class="note-box" id="noteBox">
              üí° <strong>How it works:</strong> Click on text or images to
              select them (red border appears). Selected items can be deleted
              individually or in batch. Then click "Save Changes" to download
              your cleaned PDF.
            </div>

            <div id="resultBtns" style="display: none; margin-top: 30px">
              <div class="result-card">
                <i class="fa fa-file-pdf" aria-hidden="true"></i>
              </div>
              <p class="file-name">
                <a href="#" id="fileNameLink">cleaned.pdf</a>
              </p>
              <div class="result-btns-container">
                <a
                  id="downloadBtn"
                  href="#"
                  class="cta-button"
                  download
                  aria-label="Download cleaned PDF file"
                >
                  <i class="fa fa-download" aria-hidden="true"></i> Download
                </a>
                <a
                  id="shareBtn"
                  href="#"
                  class="cta-button"
                  aria-label="Share cleaned PDF file"
                >
                  <i class="fa fa-share-alt" aria-hidden="true"></i> Share
                </a>
                <button
                  id="resetBtn"
                  class="secondary-btn"
                  aria-label="Remove watermark from another PDF"
                >
                  <i class="fa fa-rotate-right" aria-hidden="true"></i> Remove
                  Another
                </button>
              </div>
            </div>
          </div>

          <div id="pdfPreview" style="display: none; margin-top: 30px">
            <h2>Preview Cleaned PDF</h2>
            <iframe
              id="pdfFrame"
              width="100%"
              height="600"
              title="Cleaned PDF preview"
              style="border-radius: 12px; border: 1px solid #e5e7eb"
            ></iframe>
          </div>
        </div>
      </section>

      <!-- The Story Behind This Tool (Real Reason I Built It) -->
      <section class="features" style="background: #f9fafb; padding: 60px 20px">
        <div class="container">
          <h2>Why I Built This Watermark Removal Tool</h2>
          <div style="max-width: 900px; margin: 0 auto; text-align: left">
            <div
              style="
                background: white;
                padding: 30px;
                border-radius: 12px;
                margin-bottom: 30px;
              "
            >
              <p
                style="
                  color: #555;
                  line-height: 1.8;
                  font-size: 16px;
                  margin-bottom: 20px;
                "
              >
                A few years ago, I was updating a bunch of old company
                documents. Someone had stamped "DRAFT - CONFIDENTIAL" across
                every page years ago, and now those documents needed to be final
                versions for clients. I spent hours manually trying to cover
                them up in editing software. It looked terrible and took
                forever.
              </p>
              <p
                style="
                  color: #555;
                  line-height: 1.8;
                  font-size: 16px;
                  margin-bottom: 20px;
                "
              >
                Then a marketing agency reached out - they'd rebranded and had
                thousands of PDFs with their old logo as a watermark. Recreating
                them from scratch would have cost them months of work.
              </p>
              <p style="color: #555; line-height: 1.8; font-size: 16px">
                That's when I realized people needed a way to clean up their own
                documents. This tool lets you click on any watermark - text or
                image - and delete it permanently. Your original content stays
                exactly the same, just without the marks you don't want anymore.
              </p>
            </div>

            <h3 style="color: #1e3a8a; margin-bottom: 15px; margin-top: 25px">
              Real People, Real Reasons (From Emails)
            </h3>

            <div style="display: grid; gap: 15px; margin-bottom: 30px">
              <div
                style="
                  background: white;
                  padding: 15px 20px;
                  border-radius: 8px;
                  border-left: 4px solid #4f46e5;
                "
              >
                <p style="color: #555; line-height: 1.8">
                  <strong>üè¢ The rebranding agency:</strong> "We changed our
                  company name and had 5,000 PDFs with the old logo watermark.
                  This tool saved us from having to recreate everything." -
                  Marketing agency owner
                </p>
              </div>
              <div
                style="
                  background: white;
                  padding: 15px 20px;
                  border-radius: 8px;
                  border-left: 4px solid #4f46e5;
                "
              >
                <p style="color: #555; line-height: 1.8">
                  <strong>üìù The writer:</strong> "I added 'DRAFT' to my
                  manuscript while editing. Forgot to remove it before sending
                  to publishers. This tool fixed it in seconds." - Author
                </p>
              </div>
              <div
                style="
                  background: white;
                  padding: 15px 20px;
                  border-radius: 8px;
                  border-left: 4px solid #4f46e5;
                "
              >
                <p style="color: #555; line-height: 1.8">
                  <strong>‚öñÔ∏è The legal team:</strong> "Old contracts had
                  'INTERNAL USE ONLY' watermarks from years ago. We needed clean
                  versions for clients. Removed them all without retyping." -
                  Legal assistant
                </p>
              </div>
              <div
                style="
                  background: white;
                  padding: 15px 20px;
                  border-radius: 8px;
                  border-left: 4px solid #4f46e5;
                "
              >
                <p style="color: #555; line-height: 1.8">
                  <strong>üìö The researcher:</strong> "Archived PDFs from the
                  90s had scanner watermarks with dates and device IDs. Removed
                  them for a cleaner presentation." - University researcher
                </p>
              </div>
              <div
                style="
                  background: white;
                  padding: 15px 20px;
                  border-radius: 8px;
                  border-left: 4px solid #4f46e5;
                "
              >
                <p style="color: #555; line-height: 1.8">
                  <strong>üñºÔ∏è The content buyer:</strong> "Purchased a template
                  pack with 'SAMPLE' watermarks. Removed them after paying.
                  Exactly what I needed." - Small business owner
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- How to Remove Watermarks (Simple Steps) -->
      <section class="benefits" style="background: white; padding: 60px 20px">
        <div class="container">
          <h2>How to Remove Watermarks (Three Simple Steps)</h2>
          <div class="feature-grid">
            <div class="feature-card" style="background: #f9fafb">
              <div
                style="
                  font-size: 48px;
                  color: #4f46e5;
                  font-weight: bold;
                  margin-bottom: 10px;
                "
              >
                1
              </div>
              <h3>Upload Your PDF</h3>
              <p>
                Select your file. The tool scans every page and shows you all
                the watermarks it finds - text like "DRAFT" or "CONFIDENTIAL,"
                and image watermarks like logos.
              </p>
            </div>
            <div class="feature-card" style="background: #f9fafb">
              <div
                style="
                  font-size: 48px;
                  color: #4f46e5;
                  font-weight: bold;
                  margin-bottom: 10px;
                "
              >
                2
              </div>
              <h3>Click What You Want Gone</h3>
              <p>
                Every detected watermark gets a red border when you click it.
                Click multiple to select them all. Hit the X button to delete
                individually. The preview shows exactly what will be removed.
              </p>
            </div>
            <div class="feature-card" style="background: #f9fafb">
              <div
                style="
                  font-size: 48px;
                  color: #4f46e5;
                  font-weight: bold;
                  margin-bottom: 10px;
                "
              >
                3
              </div>
              <h3>Download Clean PDF</h3>
              <p>
                Click "Save Changes" and your new PDF downloads with those
                watermarks permanently gone. Your original file stays untouched
                - this makes a clean copy.
              </p>
            </div>
          </div>

          <div
            style="
              max-width: 800px;
              margin: 40px auto 0;
              background: #e8f0fe;
              padding: 20px;
              border-radius: 8px;
              text-align: center;
            "
          >
            <p style="color: #1e3a8a; font-weight: 500">
              üëÄ Important: This is for YOUR documents or ones you have
              permission to modify. Removing copyright watermarks from someone
              else's work without permission isn't cool (or legal).
            </p>
          </div>
        </div>
      </section>

      <!-- Why You'd Need This (Real Talk) -->
      <section class="features" style="background: #f9fafb; padding: 60px 20px">
        <div class="container">
          <h2>Why You Might Need to Remove Watermarks</h2>
          <div style="max-width: 900px; margin: 0 auto; text-align: left">
            <div
              style="
                margin-bottom: 40px;
                background: white;
                padding: 25px;
                border-radius: 12px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 15px">
                üè¢ Your Own Documents
              </h3>
              <p style="color: #555; line-height: 1.8">
                That marketing agency I mentioned? They'd added their old logo
                as a watermark to thousands of PDFs over five years. When they
                rebranded, every single document looked outdated. They couldn't
                afford to recreate everything. This tool let them remove the old
                logo in bulk and add the new one later.
              </p>
            </div>

            <div
              style="
                margin-bottom: 40px;
                background: white;
                padding: 25px;
                border-radius: 12px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 15px">
                üìù Draft to Final
              </h3>
              <p style="color: #555; line-height: 1.8">
                I still do this: add "DRAFT" to documents during editing so
                nobody mistakes them for final. But then comes the day you need
                the final version. Forgetting to remove that watermark means
                clients see "DRAFT" on their finished report. Awkward. This tool
                fixes that.
              </p>
            </div>

            <div
              style="
                margin-bottom: 40px;
                background: white;
                padding: 25px;
                border-radius: 12px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 15px">
                üîì Removing Old Security Labels
              </h3>
              <p style="color: #555; line-height: 1.8">
                Legal documents often get marked "CONFIDENTIAL" during internal
                review. Once approved for public filing or client sharing, those
                labels need to go. Same with "ATTORNEY-CLIENT PRIVILEGE" or
                "INTERNAL USE ONLY." The content is the same, but the status
                changes.
              </p>
            </div>

            <div
              style="
                margin-bottom: 40px;
                background: white;
                padding: 25px;
                border-radius: 12px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 15px">
                üñºÔ∏è Sample to Purchased
              </h3>
              <p style="color: #555; line-height: 1.8">
                If you've ever bought stock templates, design assets, or premium
                content, you know they come with "SAMPLE" or "PREVIEW"
                watermarks until you pay. After purchase, you get to remove
                them. That's exactly what this tool is for - taking your
                legitimately purchased content and making it usable.
              </p>
            </div>

            <div
              style="
                margin-bottom: 40px;
                background: white;
                padding: 25px;
                border-radius: 12px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 15px">
                üìá Scanner Artifacts
              </h3>
              <p style="color: #555; line-height: 1.8">
                Old scanners sometimes stamp metadata right onto scans - dates,
                device IDs, "Property of [Company]" watermarks. A university
                researcher emailed me about this. They had thousands of
                historical documents with scanner watermarks from the 90s that
                made them look messy. Removed them all for a clean archive.
              </p>
            </div>

            <div
              style="
                margin-bottom: 40px;
                background: white;
                padding: 25px;
                border-radius: 12px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 15px">
                üîÑ Merging Documents
              </h3>
              <p style="color: #555; line-height: 1.8">
                When you combine PDFs from different sources, they might have
                different watermarks - some "DRAFT," some "CONFIDENTIAL," some
                with logos. It looks unprofessional. Removing them all before
                merging gives you one clean, consistent document.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- What This Tool Can and Can't Do (Honest) -->
      <section class="features" style="background: white; padding: 60px 20px">
        <div class="container">
          <h2>What This Tool Can and Can't Do (Being Honest)</h2>
          <div style="max-width: 900px; margin: 0 auto; text-align: left">
            <div
              style="
                margin-bottom: 30px;
                background: #f9fafb;
                padding: 25px;
                border-radius: 12px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 15px">
                ‚úÖ What It CAN Remove
              </h3>
              <ul style="color: #555; line-height: 1.8; padding-left: 20px">
                <li style="margin-bottom: 10px">
                  <strong>Text watermarks</strong> - "DRAFT," "CONFIDENTIAL,"
                  "SAMPLE," your name, company names
                </li>
                <li style="margin-bottom: 10px">
                  <strong>Image watermarks</strong> - logos, stamps, signatures
                  added as image layers
                </li>
                <li style="margin-bottom: 10px">
                  <strong>Header/footer stamps</strong> - those "Property of X"
                  lines at page edges
                </li>
                <li style="margin-bottom: 10px">
                  <strong>Repeated elements</strong> - same watermark on every
                  page, removed in one batch
                </li>
              </ul>
            </div>

            <div
              style="
                margin-bottom: 30px;
                background: #fef3f3;
                padding: 25px;
                border-radius: 12px;
                border-left: 4px solid #dc2626;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 15px">
                ‚ùå What It CAN'T Remove
              </h3>
              <ul style="color: #555; line-height: 1.8; padding-left: 20px">
                <li style="margin-bottom: 10px">
                  <strong>Watermarks printed on scanned documents</strong> - If
                  someone printed a PDF with a watermark and then scanned it,
                  the watermark becomes part of the image. This tool can't
                  separate it.
                </li>
                <li style="margin-bottom: 10px">
                  <strong>Password-protected PDFs</strong> - Unlock them first,
                  then remove watermarks.
                </li>
                <li style="margin-bottom: 10px">
                  <strong
                    >Watermarks merged into the background during PDF
                    creation</strong
                  >
                  - Some PDF generators bake watermarks directly into the page
                  image. These aren't removable as separate objects.
                </li>
              </ul>
            </div>

            <div
              style="
                background: #f9fafb;
                padding: 20px;
                border-radius: 8px;
                margin-top: 20px;
              "
            >
              <p style="color: #1e3a8a; font-weight: 500">
                ‚ö° If you're not sure whether your watermark can be removed, try
                uploading a test page. The preview will show you what's
                detected. If it shows up with a red border when clicked, it's
                removable.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Tips From Someone Who's Removed Thousands of Watermarks -->
      <section class="features" style="background: #f9fafb; padding: 60px 20px">
        <div class="container">
          <h2>Tips From Someone Who's Removed Thousands of Watermarks</h2>
          <div style="max-width: 900px; margin: 0 auto; text-align: left">
            <div
              style="
                margin-bottom: 35px;
                padding-left: 20px;
                border-left: 4px solid #4f46e5;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                üëÅÔ∏è Preview before you delete
              </h3>
              <p style="color: #555; line-height: 1.8">
                The preview exists for a reason. I've accidentally clicked on
                actual content thinking it was a watermark. The red border shows
                you exactly what will be removed. Look at it before hitting
                delete.
              </p>
            </div>

            <div
              style="
                margin-bottom: 35px;
                padding-left: 20px;
                border-left: 4px solid #4f46e5;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                üìã Test one page first
              </h3>
              <p style="color: #555; line-height: 1.8">
                If you're not sure how it'll look, remove watermarks from just
                the first page, download it, and check. If it looks good, go
                back and do the whole document. If not, you haven't wasted time
                on 100 pages.
              </p>
            </div>

            <div
              style="
                margin-bottom: 35px;
                padding-left: 20px;
                border-left: 4px solid #4f46e5;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                üíæ Keep the original
              </h3>
              <p style="color: #555; line-height: 1.8">
                Always, always keep the original watermarked file somewhere. You
                might need it later for proof, or realize you actually wanted a
                different version. I learned this after deleting originals too
                soon and regretting it.
              </p>
            </div>

            <div
              style="
                margin-bottom: 35px;
                padding-left: 20px;
                border-left: 4px solid #4f46e5;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                üîç Check after downloading
              </h3>
              <p style="color: #555; line-height: 1.8">
                Open the cleaned PDF and flip through a few pages. Make sure all
                the watermarks you wanted gone are actually gone. Sometimes
                watermarks hide in unexpected places.
              </p>
            </div>

            <div
              style="
                margin-bottom: 35px;
                padding-left: 20px;
                border-left: 4px solid #4f46e5;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                üì¶ Batch similar watermarks together
              </h3>
              <p style="color: #555; line-height: 1.8">
                If you have 50 PDFs all with the same watermark, process them in
                one sitting. Same settings, same approach. Much faster than
                doing them randomly over a week.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Common Problems (And Fixes) -->
      <section class="features" style="background: white; padding: 60px 20px">
        <div class="container">
          <h2>Stuff That Goes Wrong (And How to Fix It)</h2>
          <div style="max-width: 900px; margin: 0 auto; text-align: left">
            <div
              style="
                margin-bottom: 25px;
                background: #f9fafb;
                padding: 20px;
                border-radius: 12px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                üîç "The tool didn't detect my watermark"
              </h3>
              <p style="color: #555; line-height: 1.8">
                If your watermark was added as part of the page image (like in a
                scanned document), it's not a separate object and won't be
                detected. Try one of these: If it's a text watermark, maybe run
                OCR first to convert it to selectable text. If it's an image,
                this tool might not work for that file.
              </p>
            </div>

            <div
              style="
                margin-bottom: 25px;
                background: #f9fafb;
                padding: 20px;
                border-radius: 12px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                üéØ "I accidentally selected the wrong thing"
              </h3>
              <p style="color: #555; line-height: 1.8">
                Click it again to deselect, or use the "Clear Selection" button
                to start over. Nothing gets deleted until you hit "Save
                Changes."
              </p>
            </div>

            <div
              style="
                margin-bottom: 25px;
                background: #f9fafb;
                padding: 20px;
                border-radius: 12px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                üîí "It won't let me upload my PDF"
              </h3>
              <p style="color: #555; line-height: 1.8">
                Password protected? Use the Unlock PDF tool first. Encrypted
                files can't be edited until they're unlocked.
              </p>
            </div>

            <div
              style="
                margin-bottom: 25px;
                background: #f9fafb;
                padding: 20px;
                border-radius: 12px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                üêå "Processing is taking forever"
              </h3>
              <p style="color: #555; line-height: 1.8">
                Big files with lots of watermarks take time. A 200-page document
                with watermarks on every page might need a minute or two. If
                it's really stuck, refresh and try again with a smaller file.
              </p>
            </div>

            <div
              style="
                margin-bottom: 25px;
                background: #f9fafb;
                padding: 20px;
                border-radius: 12px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                üìâ "The quality dropped after removal"
              </h3>
              <p style="color: #555; line-height: 1.8">
                It shouldn't. Removing watermarks just deletes those objects -
                it doesn't recompress the rest. If quality seems worse, check if
                the watermark was covering important content that looked
                different underneath. If it's a bug, email me.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- FAQ - Real Questions -->
      <section class="features" style="background: #f9fafb; padding: 60px 20px">
        <div class="container">
          <h2>Questions People Actually Ask</h2>
          <div style="max-width: 800px; margin: 0 auto; text-align: left">
            <div
              style="
                margin-bottom: 30px;
                border-bottom: 1px solid #e5e7eb;
                padding-bottom: 20px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                "Is it legal to remove watermarks?"
              </h3>
              <p style="color: #555; line-height: 1.8">
                It depends. If it's YOUR document - you created it, you own it,
                or you have permission - then yes. If it's someone else's
                copyrighted work and you're removing their copyright mark
                without permission, that's not okay. This tool is for cleaning
                up your own stuff, not stealing other people's.
              </p>
            </div>

            <div
              style="
                margin-bottom: 30px;
                border-bottom: 1px solid #e5e7eb;
                padding-bottom: 20px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                "Can I remove watermarks from multiple PDFs at once?"
              </h3>
              <p style="color: #555; line-height: 1.8">
                One at a time for now. If you have a batch of similar files, you
                can do them one after another. I might add batch processing if
                enough people ask.
              </p>
            </div>

            <div
              style="
                margin-bottom: 30px;
                border-bottom: 1px solid #e5e7eb;
                padding-bottom: 20px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                "Will this work on watermarks added by Adobe Acrobat?"
              </h3>
              <p style="color: #555; line-height: 1.8">
                Yes. Watermarks added by any PDF software that creates separate
                objects should be detected. If it was added as a proper
                watermark (not burned into the image), it's removable.
              </p>
            </div>

            <div
              style="
                margin-bottom: 30px;
                border-bottom: 1px solid #e5e7eb;
                padding-bottom: 20px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                "Do you keep my files?"
              </h3>
              <p style="color: #555; line-height: 1.8">
                Small files process in your browser - never uploaded. Large
                files get deleted from servers immediately after processing. I
                don't keep anything.
              </p>
            </div>

            <div
              style="
                margin-bottom: 30px;
                border-bottom: 1px solid #e5e7eb;
                padding-bottom: 20px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                "Can I undo after downloading?"
              </h3>
              <p style="color: #555; line-height: 1.8">
                No. That's why I keep saying "keep the original." Your original
                watermarked file is still there. The downloaded version has the
                changes permanently.
              </p>
            </div>

            <div
              style="
                margin-bottom: 30px;
                border-bottom: 1px solid #e5e7eb;
                padding-bottom: 20px;
              "
            >
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                "What if the watermark is on every page?"
              </h3>
              <p style="color: #555; line-height: 1.8">
                Select one instance, then use the batch selection to choose all
                pages. Delete once, and it's gone from everywhere. Much faster
                than doing each page individually.
              </p>
            </div>

            <div style="margin-bottom: 30px">
              <h3 style="color: #1e3a8a; margin-bottom: 10px">
                "Something's not working. Can you help?"
              </h3>
              <p style="color: #555; line-height: 1.8">
                Email me at <strong>nextopdf@gmail.com</strong>. Tell me what
                happened. I read everything and usually fix it within a day.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Related Tools -->
      <section class="benefits" style="background: white; padding: 60px 20px">
        <div class="container">
          <h2>Other Tools You Might Need</h2>
          <p style="text-align: center; color: #555; margin-bottom: 40px">
            Same deal - all free, no sign-ups
          </p>
          <div class="feature-grid">
            <div class="feature-card">
              <i
                class="fas fa-stamp"
                style="font-size: 40px; color: #4f46e5; margin-bottom: 15px"
              ></i>
              <h3>Add Watermark</h3>
              <p>After removing old watermarks, add new ones if needed.</p>
              <a
                href="/watermark"
                class="cta-button"
                style="font-size: 14px; padding: 8px 16px; margin-top: 10px"
                >Use Tool</a
              >
            </div>
            <div class="feature-card">
              <i
                class="fas fa-unlock"
                style="font-size: 40px; color: #4f46e5; margin-bottom: 15px"
              ></i>
              <h3>Unlock PDF</h3>
              <p>Remove password protection before watermark removal.</p>
              <a
                href="/unlock-pdf"
                class="cta-button"
                style="font-size: 14px; padding: 8px 16px; margin-top: 10px"
                >Use Tool</a
              >
            </div>
            <div class="feature-card">
              <i
                class="fas fa-file-pdf"
                style="font-size: 40px; color: #4f46e5; margin-bottom: 15px"
              ></i>
              <h3>Compress PDF</h3>
              <p>Make cleaned PDFs smaller for easier sharing.</p>
              <a
                href="/compress-pdf"
                class="cta-button"
                style="font-size: 14px; padding: 8px 16px; margin-top: 10px"
                >Use Tool</a
              >
            </div>
          </div>
        </div>
      </section>

      <!-- Simple Contact Reminder -->
      <section
        style="
          background: #f9fafb;
          padding: 30px 20px;
          text-align: center;
          border-top: 1px solid #e5e7eb;
        "
      >
        <div class="container">
          <p style="font-size: 18px; color: #1e3a8a">
            Questions? Something not working?
            <a
              href="mailto:nextopdf@gmail.com"
              style="color: #4f46e5; font-weight: bold; text-decoration: none"
              >nextopdf@gmail.com</a
            >
          </p>
          <p style="color: #555; margin-top: 10px">
            I actually reply (usually within a day)
          </p>
        </div>
      </section>
    </main>

    <div
      class="loading-overlay"
      id="loadingOverlay"
      role="alert"
      aria-live="assertive"
    >
      <div class="loading-content">
        <div class="spinner"></div>
        <p>Processing PDF...</p>
      </div>
    </div>

    <section id="footer-placeholder"></section>

    <script src="./js/app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      // Use BACKEND_BASE_URL from app.js or fallback to localhost
      const DETECT_URL = `${BACKEND_BASE_URL}/detect-watermarks`;
      const REMOVE_URL = `${BACKEND_BASE_URL}/remove-watermark`;

      const pdfUpload = document.getElementById("pdfUpload");
      const uploadSection = document.getElementById("uploadSection");
      const fileList = document.getElementById("fileList");
      const pagesGrid = document.getElementById("pagesGrid");
      const controlPanel = document.getElementById("controlPanel");
      const selectionInfo = document.getElementById("selectionInfo");
      const clearBtn = document.getElementById("clearBtn");
      const deleteBtn = document.getElementById("deleteBtn");
      const removeBtn = document.getElementById("removeBtn");
      const errorMsg = document.getElementById("errorMsg");
      const successMsg = document.getElementById("successMsg");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const resultBtns = document.getElementById("resultBtns");
      const downloadBtn = document.getElementById("downloadBtn");
      const shareBtn = document.getElementById("shareBtn");
      const resetBtn = document.getElementById("resetBtn");
      const noteBox = document.getElementById("noteBox");
      const pdfPreview = document.getElementById("pdfPreview");
      const pdfFrame = document.getElementById("pdfFrame");
      const fileNameLink = document.getElementById("fileNameLink");

      let currentFile = null;
      let detectedItems = [];
      let selectedItems = new Set();
      let pageRenderScales = {}; // Store the actual render scale for each page

      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

      function showError(msg) {
        errorMsg.textContent = msg;
        errorMsg.style.display = "inline-block";
        successMsg.classList.remove("show");
      }

      function clearError() {
        errorMsg.style.display = "none";
      }

      function showSuccess(msg) {
        successMsg.textContent = msg;
        successMsg.classList.add("show");
        clearError();
        setTimeout(() => successMsg.classList.remove("show"), 3000);
      }

      function showLoading() {
        loadingOverlay.classList.add("show");
      }

      function hideLoading() {
        loadingOverlay.classList.remove("show");
      }

      function updateSelectionInfo() {
        const selectedCount = selectedItems.size;
        if (selectedCount === 0) {
          selectionInfo.textContent = "No items selected";
        } else {
          selectionInfo.textContent = `${selectedCount} item${selectedCount > 1 ? "s" : ""} selected`;
        }
      }

      // Render file list (like merge.html)
      function renderFileList() {
        fileList.style.display = "block";
        fileList.innerHTML = "";

        const li = document.createElement("li");
        li.innerHTML = `<i class="fa fa-file-pdf pdf-icon" aria-hidden="true"></i> <span>${currentFile.name}</span> <button class="delete-file" id="deleteFileBtn" aria-label="Remove ${currentFile.name}"><i class="fa fa-times" aria-hidden="true"></i></button>`;
        fileList.appendChild(li);
      }

      // Handle file deletion
      fileList.addEventListener("click", (e) => {
        const deleteBtn = e.target.closest(".delete-file");
        if (deleteBtn) {
          resetApplication();
        }
      });

      // Proper reset function without page reload
      function resetApplication() {
        // Clear all data
        currentFile = null;
        detectedItems = [];
        selectedItems.clear();
        pageRenderScales = {};

        // Reset UI elements
        fileList.style.display = "none";
        fileList.innerHTML = "";
        uploadSection.style.display = "block";
        pagesGrid.style.display = "none";
        pagesGrid.innerHTML = "";
        controlPanel.style.display = "none";
        resultBtns.style.display = "none";
        pdfPreview.style.display = "none";
        noteBox.style.display = "block";

        // Reset file input
        pdfUpload.value = "";

        // Clear messages
        clearError();
        successMsg.classList.remove("show");

        // Reset iframe
        pdfFrame.src = "";

        // Reset download links
        if (downloadBtn.href && downloadBtn.href.startsWith("blob:")) {
          URL.revokeObjectURL(downloadBtn.href);
        }
        if (shareBtn.href && shareBtn.href.startsWith("blob:")) {
          URL.revokeObjectURL(shareBtn.href);
        }
        downloadBtn.href = "#";
        shareBtn.href = "#";

        // Scroll to top
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // Upload PDF and detect watermarks
      pdfUpload.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        clearError();
        currentFile = file;
        selectedItems.clear();
        detectedItems = [];
        pageRenderScales = {};

        // Hide upload button and show file list
        uploadSection.style.display = "none";
        renderFileList();

        showLoading();

        try {
          // Detect watermarks from backend
          const formData = new FormData();
          formData.append("file", file);

          const detectRes = await fetch(DETECT_URL, {
            method: "POST",
            body: formData,
          });

          if (!detectRes.ok) {
            const errorData = await detectRes.json().catch(() => ({}));
            throw new Error(errorData.error || "Failed to detect watermarks");
          }

          const detectData = await detectRes.json();
          detectedItems = detectData.items || [];

          await renderPDFWithOverlays(file, detectedItems);

          hideLoading();
          showSuccess(
            `‚úì Detected ${detectedItems.length} item${detectedItems.length !== 1 ? "s" : ""} (text and images)`,
          );
          controlPanel.style.display = "block";
          pagesGrid.style.display = "flex";
        } catch (error) {
          hideLoading();
          showError("Error: " + error.message);
          console.error("PDF Upload Error:", error);
          // Reset UI on error
          resetApplication();
        }
      };

      // Calculate display scale based on viewport - FIXED FOR ALL SCREEN SIZES
      function calculateDisplayScale(pdfPageWidth) {
        const container = pagesGrid.closest(".container");
        const containerWidth = container
          ? container.clientWidth
          : window.innerWidth;

        // Account for padding and margins
        let maxWidth;

        if (window.innerWidth < 480) {
          // Very small screens
          maxWidth = Math.min(containerWidth - 40, 320);
        } else if (window.innerWidth < 768) {
          // Mobile
          maxWidth = Math.min(containerWidth - 60, 480);
        } else if (window.innerWidth < 970) {
          // Medium screens (768-970px)
          maxWidth = Math.min(containerWidth - 80, 700);
        } else {
          // Desktop
          maxWidth = Math.min(containerWidth - 100, 800);
        }

        // Ensure we don't scale below a minimum width
        maxWidth = Math.max(maxWidth, 200);

        // Calculate scale to fit the PDF page width to display width
        return maxWidth / pdfPageWidth;
      }

      // Render PDF pages with overlays
      async function renderPDFWithOverlays(file, items) {
        pagesGrid.innerHTML = "";
        pageRenderScales = {};

        try {
          const fileURL = URL.createObjectURL(file);

          const loadingTask = pdfjsLib.getDocument({
            url: fileURL,
            cMapUrl: "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/",
            cMapPacked: true,
            verbosity: 0,
          });

          const pdf = await loadingTask.promise;

          // Group items by page
          const itemsByPage = {};
          items.forEach((item, idx) => {
            item.id = idx;
            const page = item.page;
            if (!itemsByPage[page]) itemsByPage[page] = [];
            itemsByPage[page].push(item);
          });

          // Render all pages sequentially
          for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            try {
              const page = await pdf.getPage(pageNum);
              const viewport = page.getViewport({ scale: 1 });

              // Calculate display scale based on viewport width
              const displayScale = calculateDisplayScale(viewport.width);

              // Store the display scale for this page
              pageRenderScales[pageNum] = displayScale;

              // Use higher render scale for sharp rendering
              const renderScale = displayScale * (window.devicePixelRatio || 2);
              const scaledViewport = page.getViewport({ scale: renderScale });

              const canvas = document.createElement("canvas");
              const context = canvas.getContext("2d", {
                willReadFrequently: false,
                alpha: false,
              });

              canvas.width = scaledViewport.width;
              canvas.height = scaledViewport.height;

              const renderTask = page.render({
                canvasContext: context,
                viewport: scaledViewport,
                intent: "display",
                enableWebGL: false,
                renderInteractiveForms: false,
              });

              await renderTask.promise;

              // Apply CSS scaling to match display size
              const displayWidth = viewport.width * displayScale;
              const displayHeight = viewport.height * displayScale;

              canvas.style.width = displayWidth + "px";
              canvas.style.height = displayHeight + "px";

              const card = document.createElement("div");
              card.className = "page-card";
              card.dataset.pageNum = pageNum;
              card.setAttribute("role", "article");
              card.setAttribute("aria-label", `Page ${pageNum}`);

              const badge = document.createElement("div");
              badge.className = "page-number-badge";
              badge.textContent = `Page ${pageNum}`;
              badge.setAttribute("aria-hidden", "true");
              card.appendChild(badge);

              const container = document.createElement("div");
              container.className = "page-canvas-container";
              container.appendChild(canvas);

              // Add overlays with correct scale
              const pageItems = itemsByPage[pageNum] || [];
              pageItems.forEach((item) => {
                const overlay = createOverlay(item, displayScale, canvas);
                container.appendChild(overlay);
              });

              card.appendChild(container);
              pagesGrid.appendChild(card);

              page.cleanup();
            } catch (pageError) {
              console.error(`Error rendering page ${pageNum}:`, pageError);
            }
          }

          URL.revokeObjectURL(fileURL);
        } catch (error) {
          console.error("Error in renderPDFWithOverlays:", error);
          throw error;
        }
      }

      function createOverlay(item, displayScale, canvas) {
        const [x0, y0, x1, y1] = item.bbox;

        const overlay = document.createElement("div");
        overlay.className = `watermark-overlay type-${item.type}`;
        overlay.dataset.itemId = item.id;
        overlay.dataset.pageNum = item.page;
        overlay.setAttribute("role", "button");
        overlay.setAttribute("tabindex", "0");
        overlay.setAttribute(
          "aria-label",
          `${item.type === "text" ? "Text watermark: " + (item.text?.substring(0, 30) || "N/A") : "Image watermark"}. Click to select for removal.`,
        );

        // Use displayScale directly
        overlay.style.left = x0 * displayScale + "px";
        overlay.style.top = y0 * displayScale + "px";
        overlay.style.width = (x1 - x0) * displayScale + "px";
        overlay.style.height = (y1 - y0) * displayScale + "px";

        // Label
        const label = document.createElement("div");
        label.className = "overlay-label";
        label.textContent =
          item.type === "text"
            ? `Text: ${item.text?.substring(0, 30) || "N/A"}`
            : "Image";
        label.setAttribute("aria-hidden", "true");
        overlay.appendChild(label);

        // Delete icon
        const deleteIcon = document.createElement("div");
        deleteIcon.className = "delete-icon";
        deleteIcon.innerHTML = '<i class="fa fa-times" aria-hidden="true"></i>';
        deleteIcon.setAttribute("role", "button");
        deleteIcon.setAttribute("aria-label", "Delete this watermark");
        deleteIcon.setAttribute("tabindex", "0");
        overlay.appendChild(deleteIcon);

        overlay.onclick = (e) => {
          if (e.target.closest(".delete-icon")) return;
          toggleSelection(item.id, overlay);
        };

        overlay.onkeydown = (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            if (!e.target.closest(".delete-icon")) {
              toggleSelection(item.id, overlay);
            }
          }
        };

        deleteIcon.onclick = (e) => {
          e.stopPropagation();
          deleteWatermark(item.id, overlay);
        };

        deleteIcon.onkeydown = (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            e.stopPropagation();
            deleteWatermark(item.id, overlay);
          }
        };

        return overlay;
      }

      function toggleSelection(itemId, overlay) {
        if (selectedItems.has(itemId)) {
          selectedItems.delete(itemId);
          overlay.classList.remove("selected");
          overlay.setAttribute("aria-pressed", "false");
        } else {
          selectedItems.add(itemId);
          overlay.classList.add("selected");
          overlay.setAttribute("aria-pressed", "true");
          clearError();
        }
        updateSelectionInfo();
      }

      // Delete single watermark immediately and update preview
      async function deleteWatermark(itemId, overlay) {
        const item = detectedItems.find((i) => i.id === itemId);
        if (!item) return;

        showLoading();
        clearError();

        try {
          const formData = new FormData();
          formData.append("files", currentFile);
          formData.append("watermarks", JSON.stringify([item]));

          const res = await fetch(REMOVE_URL, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            throw new Error(errorData.error || "Failed to remove watermark");
          }

          const blob = await res.blob();
          currentFile = new File([blob], currentFile.name, {
            type: "application/pdf",
          });

          const deletedPageNum = item.page;

          detectedItems = detectedItems.filter((i) => i.id !== itemId);
          selectedItems.delete(itemId);

          detectedItems.forEach((item, idx) => {
            item.id = idx;
          });

          await reRenderSinglePage(deletedPageNum, currentFile, detectedItems);

          updateSelectionInfo();
          hideLoading();

          showSuccess("‚úì Watermark removed successfully");
        } catch (error) {
          hideLoading();
          showError("Error: " + error.message);
        }
      }

      // Re-render only a single page
      async function reRenderSinglePage(pageNumber, file, items) {
        try {
          const fileURL = URL.createObjectURL(file);

          const loadingTask = pdfjsLib.getDocument({
            url: fileURL,
            cMapUrl: "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/",
            cMapPacked: true,
            verbosity: 0,
          });

          const pdf = await loadingTask.promise;
          const pageItems = items.filter((item) => item.page === pageNumber);

          const page = await pdf.getPage(pageNumber);
          const viewport = page.getViewport({ scale: 1 });

          // Calculate display scale
          const displayScale = calculateDisplayScale(viewport.width);

          // Update stored scale
          pageRenderScales[pageNumber] = displayScale;

          // Use higher render scale for sharp text
          const renderScale = displayScale * (window.devicePixelRatio || 2);
          const scaledViewport = page.getViewport({ scale: renderScale });

          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d", {
            willReadFrequently: false,
            alpha: false,
          });

          canvas.width = scaledViewport.width;
          canvas.height = scaledViewport.height;

          const renderTask = page.render({
            canvasContext: context,
            viewport: scaledViewport,
            intent: "display",
            enableWebGL: false,
            renderInteractiveForms: false,
          });

          await renderTask.promise;

          // Apply CSS scaling
          const displayWidth = viewport.width * displayScale;
          const displayHeight = viewport.height * displayScale;

          canvas.style.width = displayWidth + "px";
          canvas.style.height = displayHeight + "px";

          const pageCards = pagesGrid.querySelectorAll(".page-card");
          const targetCard = pageCards[pageNumber - 1];

          if (targetCard) {
            const badge = document.createElement("div");
            badge.className = "page-number-badge";
            badge.textContent = `Page ${pageNumber}`;
            badge.setAttribute("aria-hidden", "true");

            const container = document.createElement("div");
            container.className = "page-canvas-container";
            container.appendChild(canvas);

            pageItems.forEach((item) => {
              const overlay = createOverlay(item, displayScale, canvas);
              container.appendChild(overlay);
            });

            targetCard.innerHTML = "";
            targetCard.appendChild(badge);
            targetCard.appendChild(container);
          }

          page.cleanup();
          URL.revokeObjectURL(fileURL);
        } catch (error) {
          console.error(`Error re-rendering page ${pageNumber}:`, error);
          throw error;
        }
      }

      // Clear selection
      clearBtn.onclick = () => {
        const selectedOverlays = document.querySelectorAll(
          ".watermark-overlay.selected",
        );

        if (selectedOverlays.length === 0) {
          showError("You haven't selected any items to clear");
          return;
        }

        selectedItems.clear();

        selectedOverlays.forEach((el) => {
          el.classList.remove("selected");
          el.setAttribute("aria-pressed", "false");
        });

        updateSelectionInfo();
        clearError();
      };

      // Delete selected items in batch
      deleteBtn.onclick = async () => {
        if (selectedItems.size === 0) {
          showError("Please select items to delete first!");
          return;
        }

        showLoading();
        clearError();

        try {
          const itemsToRemove = Array.from(selectedItems)
            .map((id) => detectedItems.find((i) => i.id === id))
            .filter(Boolean);

          const affectedPages = [
            ...new Set(itemsToRemove.map((item) => item.page)),
          ];

          const formData = new FormData();
          formData.append("files", currentFile);
          formData.append("watermarks", JSON.stringify(itemsToRemove));

          const res = await fetch(REMOVE_URL, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            throw new Error(
              errorData.error || "Failed to delete selected watermarks",
            );
          }

          const blob = await res.blob();
          currentFile = new File([blob], currentFile.name, {
            type: "application/pdf",
          });

          detectedItems = detectedItems.filter((i) => !selectedItems.has(i.id));

          detectedItems.forEach((item, idx) => {
            item.id = idx;
          });

          for (const pageNum of affectedPages) {
            await reRenderSinglePage(pageNum, currentFile, detectedItems);
          }

          selectedItems.clear();
          updateSelectionInfo();
          hideLoading();

          showSuccess(
            `‚úì Deleted ${itemsToRemove.length} watermark${itemsToRemove.length !== 1 ? "s" : ""}`,
          );
        } catch (error) {
          hideLoading();
          showError("Error: " + error.message);
        }
      };

      // Save Changes button
      removeBtn.onclick = () => {
        const url = URL.createObjectURL(currentFile);
        downloadBtn.href = url;
        downloadBtn.download = "cleaned.pdf";
        shareBtn.href = url;

        uploadSection.style.display = "none";
        fileList.style.display = "none";
        pagesGrid.style.display = "none";
        controlPanel.style.display = "none";
        noteBox.style.display = "none";

        resultBtns.style.display = "block";

        const isSmallDevice = window.matchMedia("(max-width: 768px)").matches;

        if (!isSmallDevice) {
          pdfFrame.src = url;
          pdfPreview.style.display = "block";
        }

        fileNameLink.onclick = (e) => {
          e.preventDefault();
          if (isSmallDevice) {
            window.open(url, "_blank");
          } else {
            pdfPreview.scrollIntoView({ behavior: "smooth" });
          }
        };
      };

      // Reset page
      resetBtn.onclick = () => {
        resetApplication();
      };

      // Handle window resize to maintain proper overlay positioning
      let resizeTimeout;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(async () => {
          if (currentFile && detectedItems.length > 0) {
            // Re-render all pages with new scale
            await renderPDFWithOverlays(currentFile, detectedItems);
            updateSelectionInfo();
          }
        }, 300);
      });
    </script>
  </body>
</html>
