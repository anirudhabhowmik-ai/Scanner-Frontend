<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Remove Watermark from PDF Online Free | NextoPDF</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Inter:wght@400;500&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Main CSS -->
    <link rel="stylesheet" href="./css/style.css" />

    <style>
      .pages-grid {
        display: flex;
        flex-direction: column;
        gap: 30px;
        margin-top: 20px;
        align-items: center;
      }

      .page-card {
        position: relative;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        width: fit-content;
        max-width: 100%;
        transition: all 0.3s ease;
      }

      .page-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .page-canvas-container {
        position: relative;
        display: inline-block;
      }

      .page-card canvas {
        display: block;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        max-width: min(100%, 800px) !important;
      }

      .page-number-badge {
        position: absolute;
        top: -8px;
        left: 8px;
        background: #4f46e5;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        z-index: 5;
      }

      .watermark-overlay {
        position: absolute;
        cursor: pointer;
        user-select: none;
        z-index: 10;
        transition: all 0.2s ease;
        border: 2px solid transparent;
      }

      .watermark-overlay.type-text {
        background: rgba(239, 68, 68, 0.1);
      }

      .watermark-overlay.type-text:hover {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.2);
      }

      .watermark-overlay.type-image {
        background: rgba(59, 130, 246, 0.1);
        border: 2px dashed transparent;
      }

      .watermark-overlay.type-image:hover {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.2);
      }

      .watermark-overlay.selected {
        border-color: #ef4444 !important;
        background: rgba(239, 68, 68, 0.3) !important;
        border-style: solid !important;
      }

      .watermark-overlay.deleted {
        display: none;
      }

      .overlay-label {
        position: absolute;
        top: -22px;
        left: 0;
        background: #1e40af;
        color: white;
        padding: 2px 8px;
        font-size: 11px;
        border-radius: 4px;
        white-space: nowrap;
        display: none;
        z-index: 30;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .watermark-overlay:hover .overlay-label {
        display: block;
      }

      .delete-icon {
        position: absolute;
        top: -10px;
        right: -10px;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        z-index: 20;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        cursor: pointer;
      }

      .watermark-overlay.selected .delete-icon {
        display: flex;
      }

      .delete-icon:hover {
        background: #dc2626;
        transform: scale(1.1);
      }

      #controlPanel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 3px solid #ef4444;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        padding: 15px;
        display: none;
      }

      #controlPanel.show {
        display: block;
      }

      .control-content {
        max-width: 1200px;
        margin: 0 auto;
        text-align: center;
      }

      .selection-info {
        font-size: 14px;
        color: #1e3a8a;
        margin-bottom: 12px;
        font-weight: 600;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .action-buttons button {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .note-box {
        background: #f0f9ff;
        border-left: 4px solid #3b82f6;
        padding: 12px 16px;
        margin-top: 15px;
        font-size: 14px;
        border-radius: 4px;
      }

      .success-message {
        background: #d1fae5;
        border-left: 4px solid #059669;
        padding: 12px 16px;
        margin-top: 15px;
        font-size: 14px;
        border-radius: 4px;
        color: #065f46;
        display: none;
      }

      .success-message.show {
        display: block;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .loading-overlay.show {
        display: flex;
      }

      .loading-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
      }

      .spinner {
        border: 4px solid #f3f4f6;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body>
    <section id="header-placeholder"></section>

    <main>
      <section class="merge-tool">
        <div class="container">
          <h1>Remove Watermark from PDF Online</h1>
          <p>
            Upload your PDF and click on any text or image to select watermarks
            for removal. Uses PyMuPDF for accurate detection and permanent
            deletion.
          </p>

          <div class="upload-section">
            <div id="uploadSection">
              <label class="upload-label" for="pdfUpload">
                <i class="fa fa-upload"></i> Choose PDF file
              </label>
              <input type="file" id="pdfUpload" accept=".pdf" />
            </div>

            <div class="success-message" id="successMsg"></div>
            <p class="error-text" id="errorMsg" style="display: none"></p>

            <div id="pagesGrid" class="pages-grid" style="display: none"></div>

            <div id="controlPanel">
              <div class="control-content">
                <div class="selection-info" id="selectionInfo">
                  No items selected
                </div>
                <div class="action-buttons">
                  <button id="clearBtn" class="secondary-btn">
                    <i class="fa fa-times"></i> Clear Selection
                  </button>
                  <button
                    id="deleteBtn"
                    class="cta-button"
                    style="background: #f59e0b"
                  >
                    <i class="fa fa-trash"></i> Delete Selected
                  </button>
                  <button id="removeBtn" class="cta-button">
                    <i class="fa fa-eraser"></i> Remove Watermarks
                  </button>
                </div>
              </div>
            </div>

            <div class="note-box">
              ðŸ’¡ <strong>How it works:</strong> Click on text or images to
              select them (red border appears). Selected items can be deleted
              individually or in batch. Then click "Remove Watermarks" to
              permanently delete them from your PDF.
            </div>

            <div id="resultBtns" style="display: none; margin-top: 30px">
              <div class="result-card">
                <i class="fa fa-file-pdf"></i>
              </div>
              <p class="file-name">
                <a href="#" id="fileNameLink">cleaned.pdf</a>
              </p>
              <div class="result-btns-container">
                <a id="downloadBtn" href="#" class="cta-button" download>
                  <i class="fa fa-download"></i> Download
                </a>
                <button id="resetBtn" class="secondary-btn">
                  <i class="fa fa-rotate-right"></i> Remove Another
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-content">
        <div class="spinner"></div>
        <p>Processing PDF...</p>
      </div>
    </div>

    <section id="footer-placeholder"></section>

    <script src="./js/app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      const DETECT_URL = `http://127.0.0.1:8080/detect-watermarks`;
      const REMOVE_URL = `http://127.0.0.1:8080/remove-watermark`;

      const pdfUpload = document.getElementById("pdfUpload");
      const pagesGrid = document.getElementById("pagesGrid");
      const controlPanel = document.getElementById("controlPanel");
      const selectionInfo = document.getElementById("selectionInfo");
      const clearBtn = document.getElementById("clearBtn");
      const deleteBtn = document.getElementById("deleteBtn");
      const removeBtn = document.getElementById("removeBtn");
      const errorMsg = document.getElementById("errorMsg");
      const successMsg = document.getElementById("successMsg");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const resultBtns = document.getElementById("resultBtns");
      const downloadBtn = document.getElementById("downloadBtn");
      const resetBtn = document.getElementById("resetBtn");
      const uploadSection = document.getElementById("uploadSection");

      let currentFile = null;
      let detectedItems = [];
      let selectedItems = new Set();
      let deletedItems = new Set();

      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

      function showError(msg) {
        errorMsg.textContent = msg;
        errorMsg.style.display = "block";
        successMsg.classList.remove("show");
      }

      function clearError() {
        errorMsg.style.display = "none";
      }

      function showSuccess(msg) {
        successMsg.textContent = msg;
        successMsg.classList.add("show");
        clearError();
        setTimeout(() => successMsg.classList.remove("show"), 3000);
      }

      function showLoading() {
        loadingOverlay.classList.add("show");
      }

      function hideLoading() {
        loadingOverlay.classList.remove("show");
      }

      function updateSelectionInfo() {
        const selectedCount = selectedItems.size;
        const deletedCount = deletedItems.size;

        if (selectedCount === 0 && deletedCount === 0) {
          selectionInfo.textContent = "No items selected";
          controlPanel.classList.remove("show");
        } else {
          const parts = [];
          if (selectedCount > 0) parts.push(`${selectedCount} selected`);
          if (deletedCount > 0)
            parts.push(`${deletedCount} marked for deletion`);
          selectionInfo.textContent = parts.join(", ");
          controlPanel.classList.add("show");
        }
      }

      pdfUpload.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        clearError();
        currentFile = file;
        selectedItems.clear();
        deletedItems.clear();
        detectedItems = [];

        showLoading();

        try {
          // Step 1: Detect watermarks using backend PyMuPDF
          const formData = new FormData();
          formData.append("file", file);

          const detectRes = await fetch(DETECT_URL, {
            method: "POST",
            body: formData,
          });

          if (!detectRes.ok) {
            throw new Error("Failed to detect watermarks");
          }

          const detectData = await detectRes.json();
          detectedItems = detectData.items || [];

          // Step 2: Render PDF pages with PDF.js
          await renderPDFWithOverlays(file, detectedItems);

          hideLoading();
          showSuccess(
            `âœ“ Detected ${detectedItems.length} items (text and images)`,
          );
          pagesGrid.style.display = "flex";
        } catch (error) {
          hideLoading();
          showError("Error: " + error.message);
        }
      };

      async function renderPDFWithOverlays(file, items) {
        pagesGrid.innerHTML = "";

        const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file))
          .promise;

        // Group items by page
        const itemsByPage = {};
        items.forEach((item, idx) => {
          item.id = idx;
          const page = item.page;
          if (!itemsByPage[page]) itemsByPage[page] = [];
          itemsByPage[page].push(item);
        });

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const viewport = page.getViewport({ scale: 1 });

          const maxWidth = Math.min(800, window.innerWidth - 40);
          const scale = Math.min(maxWidth / viewport.width, 1.5);
          const scaledViewport = page.getViewport({ scale });

          const canvas = document.createElement("canvas");
          canvas.width = scaledViewport.width;
          canvas.height = scaledViewport.height;

          await page.render({
            canvasContext: canvas.getContext("2d"),
            viewport: scaledViewport,
          }).promise;

          const card = document.createElement("div");
          card.className = "page-card";

          const badge = document.createElement("div");
          badge.className = "page-number-badge";
          badge.textContent = `Page ${pageNum}`;
          card.appendChild(badge);

          const container = document.createElement("div");
          container.className = "page-canvas-container";
          container.appendChild(canvas);

          // Add overlays for items on this page
          const pageItems = itemsByPage[pageNum] || [];
          pageItems.forEach((item) => {
            const overlay = createOverlay(item, scale);
            container.appendChild(overlay);
          });

          card.appendChild(container);
          pagesGrid.appendChild(card);
        }
      }

      function createOverlay(item, scale) {
        const bbox = item.bbox;
        const [x0, y0, x1, y1] = bbox;

        const overlay = document.createElement("div");
        overlay.className = `watermark-overlay type-${item.type}`;
        overlay.dataset.itemId = item.id;

        overlay.style.left = x0 * scale + "px";
        overlay.style.top = y0 * scale + "px";
        overlay.style.width = (x1 - x0) * scale + "px";
        overlay.style.height = (y1 - y0) * scale + "px";

        const label = document.createElement("div");
        label.className = "overlay-label";
        if (item.type === "text") {
          label.textContent = `Text: ${item.text.substring(0, 30)}`;
        } else {
          label.textContent = `Image`;
        }
        overlay.appendChild(label);

        const deleteIcon = document.createElement("div");
        deleteIcon.className = "delete-icon";
        deleteIcon.innerHTML = '<i class="fa fa-times"></i>';
        overlay.appendChild(deleteIcon);

        overlay.onclick = (e) => {
          if (e.target.closest(".delete-icon")) return;
          toggleSelection(item.id, overlay);
        };

        deleteIcon.onclick = (e) => {
          e.stopPropagation();
          markForDeletion(item.id, overlay);
        };

        return overlay;
      }

      function toggleSelection(itemId, overlay) {
        if (deletedItems.has(itemId)) return;

        if (selectedItems.has(itemId)) {
          selectedItems.delete(itemId);
          overlay.classList.remove("selected");
        } else {
          selectedItems.add(itemId);
          overlay.classList.add("selected");
        }
        updateSelectionInfo();
      }

      function markForDeletion(itemId, overlay) {
        selectedItems.delete(itemId);
        deletedItems.add(itemId);
        overlay.classList.add("deleted");
        updateSelectionInfo();
      }

      clearBtn.onclick = () => {
        selectedItems.clear();
        document.querySelectorAll(".watermark-overlay").forEach((el) => {
          el.classList.remove("selected");
        });
        updateSelectionInfo();
      };

      deleteBtn.onclick = () => {
        const count = selectedItems.size;
        selectedItems.forEach((id) => {
          deletedItems.add(id);
          const overlay = document.querySelector(`[data-item-id="${id}"]`);
          if (overlay) overlay.classList.add("deleted");
        });
        selectedItems.clear();
        updateSelectionInfo();
        showSuccess(`âœ“ Marked ${count} item(s) for deletion`);
      };

      removeBtn.onclick = async () => {
        if (deletedItems.size === 0) {
          showError("Please select items to delete first!");
          return;
        }

        clearError();
        showLoading();

        try {
          const itemsToRemove = Array.from(deletedItems)
            .map((id) => {
              return detectedItems.find((item) => item.id === id);
            })
            .filter(Boolean);

          const formData = new FormData();
          formData.append("files", currentFile);
          formData.append("watermarks", JSON.stringify(itemsToRemove));

          const res = await fetch(REMOVE_URL, {
            method: "POST",
            body: formData,
          });

          if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            throw new Error(errorData.error || "Failed to remove watermarks");
          }

          const blob = await res.blob();
          const url = URL.createObjectURL(blob);

          downloadBtn.href = url;
          downloadBtn.download = "cleaned.pdf";

          hideLoading();
          uploadSection.style.display = "none";
          pagesGrid.style.display = "none";
          controlPanel.style.display = "none";
          document.querySelector(".note-box").style.display = "none";
          resultBtns.style.display = "block";
        } catch (error) {
          hideLoading();
          showError("Error: " + error.message);
        }
      };

      resetBtn.onclick = () => {
        location.reload();
      };
    </script>
  </body>
</html>
