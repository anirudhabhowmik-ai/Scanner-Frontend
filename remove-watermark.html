<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Remove Watermark from PDF Online Free - Fast & Easy | NextoPDF
    </title>
    <meta
      name="title"
      content="Remove Watermark from PDF Online Free - Fast & Easy | NextoPDF"
    />
    <meta
      name="description"
      content="Remove watermarks from PDF files online for free. Click and select text or image watermarks to delete permanently. Uses PyMuPDF for accurate detection and removal."
    />
    <meta
      name="keywords"
      content="remove watermark from PDF, delete watermark PDF, PDF watermark remover free, remove text watermark, remove image watermark, clean PDF, unwatermark PDF"
    />
    <meta name="author" content="NextoPDF" />
    <meta
      name="robots"
      content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"
    />
    <link rel="canonical" href="https://nextopdf.com/remove-watermark" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://nextopdf.com/remove-watermark" />
    <meta
      property="og:title"
      content="Remove Watermark from PDF Online Free - Fast & Easy | NextoPDF"
    />
    <meta
      property="og:description"
      content="Remove watermarks from PDF files online for free. Click and select text or image watermarks to delete permanently."
    />
    <meta
      property="og:image"
      content="https://nextopdf.com/images/og-image.png"
    />
    <meta property="og:site_name" content="NextoPDF" />
    <meta property="og:locale" content="en_US" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://nextopdf.com/remove-watermark" />
    <meta
      name="twitter:title"
      content="Remove Watermark from PDF Online Free - Fast & Easy | NextoPDF"
    />
    <meta
      name="twitter:description"
      content="Remove watermarks from PDF files online for free. Click and select text or image watermarks to delete permanently."
    />
    <meta
      name="twitter:image"
      content="https://nextopdf.com/images/twitter-card.png"
    />
    <meta name="google-adsense-account" content="ca-pub-5797619165090350" />

    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "NextoPDF - Remove Watermark from PDF",
        "url": "https://nextopdf.com/remove-watermark",
        "description": "Free online tool to remove text and image watermarks from PDF documents with accurate detection and permanent deletion",
        "applicationCategory": "UtilitiesApplication",
        "operatingSystem": "Any",
        "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
        "featureList": "Remove text watermarks, Remove image watermarks, Batch processing, Visual selection, Permanent deletion, PyMuPDF powered"
      }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Inter:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="./css/style.css" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./images/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="./images/favicon-16x16.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="./images/apple-touch-icon.png"
    />

    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5797619165090350"
      crossorigin="anonymous"
    ></script>

    <style>
      .pages-grid {
        display: flex;
        flex-direction: column;
        gap: 30px;
        margin-top: 20px;
        align-items: center;
      }
      .page-card {
        position: relative;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        width: fit-content;
        max-width: 100%;
        transition: all 0.3s ease;
      }
      @media (max-width: 768px) {
        .page-card {
          padding: 15px;
        }
      }
      .page-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .page-canvas-container {
        position: relative;
        display: inline-block;
        line-height: 0;
      }
      .page-card canvas {
        display: block;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        max-width: 100% !important;
        height: auto !important;
      }
      .page-number-badge {
        position: absolute;
        top: -8px;
        left: 8px;
        background: #4f46e5;
        color: white;
        padding: 6px 12px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
        z-index: 5;
      }
      @media (max-width: 768px) {
        .page-number-badge {
          font-size: 12px;
          padding: 5px 10px;
        }
      }
      .watermark-overlay {
        position: absolute;
        cursor: pointer;
        user-select: none;
        z-index: 10;
        transition: all 0.2s ease;
        box-sizing: border-box;
        pointer-events: auto;
      }

      /* DEFAULT: fully transparent â€” content is readable */
      .watermark-overlay.type-text,
      .watermark-overlay.type-image {
        background: transparent;
        outline: 2px solid transparent;
        outline-offset: -2px;
      }

      /* HOVER: reveal red highlight so user knows it's clickable */
      .watermark-overlay.type-text:hover,
      .watermark-overlay.type-image:hover {
        outline-color: #ef4444 !important;
        background: rgba(239, 68, 68, 0.25) !important;
        z-index: 90;
        cursor: pointer;
      }

      /* SELECTED: bold red border + shows delete icon */
      .watermark-overlay.selected {
        outline-color: #ef4444 !important;
        background: rgba(239, 68, 68, 0.3) !important;
        outline-style: solid !important;
        outline-width: 3px !important;
        z-index: 99;
      }
      .watermark-overlay.deleted {
        display: none;
      }
      .overlay-label {
        position: absolute;
        top: -22px;
        left: 0;
        background: #1e40af;
        color: white;
        padding: 9px 4px;
        font-size: 11px;
        border-radius: 4px;
        white-space: nowrap;
        display: none;
        z-index: 30;
        max-width: 250px;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
      }
      @media (max-width: 768px) {
        .overlay-label {
          font-size: 10px;
          padding: 6px 6px;
          max-width: 200px;
          top: -14px;
        }
      }
      @media (max-width: 480px) {
        .overlay-label {
          font-size: 9px;
          padding: 5px 5px;
          max-width: 150px;
          top: -12px;
        }
      }
      .watermark-overlay:hover .overlay-label {
        display: block;
      }
      .delete-icon {
        position: absolute;
        top: -10px;
        right: -10px;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        z-index: 20;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        flex-shrink: 0;
      }
      @media (max-width: 768px) {
        .delete-icon {
          width: 20px;
          height: 20px;
          font-size: 10px;
          top: -8px;
          right: -8px;
        }
      }
      @media (max-width: 480px) {
        .delete-icon {
          width: 18px;
          height: 18px;
          font-size: 9px;
          top: -6px;
          right: -6px;
        }
      }
      .delete-icon i {
        font-size: inherit;
      }
      .watermark-overlay.selected .delete-icon {
        display: flex;
      }
      .delete-icon:hover {
        background: #dc2626;
        transform: scale(1.1);
      }
      #controlPanel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 3px solid #ef4444;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        z-index: 999;
        padding: 15px;
        display: none;
      }
      @media (max-width: 768px) {
        #controlPanel {
          padding: 12px 10px;
        }
      }
      #controlPanel.show {
        display: block;
      }
      .control-content {
        max-width: 1200px;
        margin: 0 auto;
        text-align: center;
      }
      .selection-info {
        font-size: 15px;
        color: #1e3a8a;
        margin-bottom: 12px;
        font-weight: 600;
      }
      @media (max-width: 768px) {
        .selection-info {
          font-size: 14px;
          margin-bottom: 10px;
        }
      }
      @media (max-width: 480px) {
        .selection-info {
          font-size: 13px;
        }
      }
      .action-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }
      @media (max-width: 768px) {
        .action-buttons {
          gap: 8px;
        }
      }
      .action-buttons button {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }
      @media (max-width: 768px) {
        .action-buttons button {
          padding: 10px 18px;
          font-size: 13px;
        }
      }
      @media (max-width: 480px) {
        .action-buttons button {
          padding: 10px 16px;
          font-size: 12px;
        }
      }
      .note-box {
        background: #f0f9ff;
        border-left: 4px solid #3b82f6;
        padding: 14px 18px;
        margin-top: 15px;
        font-size: 14px;
        border-radius: 4px;
        line-height: 1.6;
      }
      @media (max-width: 768px) {
        .note-box {
          font-size: 13px;
          padding: 12px 14px;
        }
      }
      @media (max-width: 480px) {
        .note-box {
          font-size: 12px;
          padding: 10px 12px;
        }
      }
      .success-message {
        background: #d1fae5;
        border-left: 4px solid #059669;
        padding: 14px 18px;
        margin-top: 15px;
        font-size: 14px;
        border-radius: 4px;
        color: #065f46;
        display: none;
        line-height: 1.6;
      }
      @media (max-width: 768px) {
        .success-message {
          font-size: 13px;
          padding: 12px 14px;
        }
      }
      @media (max-width: 480px) {
        .success-message {
          font-size: 12px;
          padding: 10px 12px;
        }
      }
      .success-message.show {
        display: block;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .loading-overlay.show {
        display: flex;
      }
      .loading-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        max-width: 90%;
      }
      @media (max-width: 768px) {
        .loading-content {
          padding: 24px;
        }
        .loading-content p {
          font-size: 14px;
        }
      }
      @media (max-width: 480px) {
        .loading-content {
          padding: 20px;
        }
        .loading-content p {
          font-size: 13px;
        }
      }
      .spinner {
        border: 4px solid #f3f4f6;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .file-list {
        display: none;
        list-style: none;
        padding: 0;
        margin: 20px 0;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }
      .file-list li {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s ease;
      }
      @media (max-width: 768px) {
        .file-list li {
          padding: 10px 12px;
          gap: 10px;
        }
      }
      .file-list li:hover {
        border-color: #4f46e5;
        transform: translateX(4px);
      }
      .pdf-icon {
        color: #ef4444;
        font-size: 20px;
      }
      @media (max-width: 768px) {
        .pdf-icon {
          font-size: 18px;
        }
      }
      .file-list li span {
        flex: 1;
        color: #1f2937;
        font-weight: 500;
        font-size: 14px;
        word-break: break-word;
      }
      @media (max-width: 768px) {
        .file-list li span {
          font-size: 13px;
        }
      }
      @media (max-width: 480px) {
        .file-list li span {
          font-size: 12px;
        }
      }
      .delete-file {
        background: #ef4444;
        border: none;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease;
        flex-shrink: 0;
      }
      .delete-file i {
        color: #fff;
      }
      .delete-file:hover {
        background: #dc2626;
      }
      .merge-tool h1 {
        font-size: 2rem;
      }
      @media (max-width: 768px) {
        .merge-tool h1 {
          font-size: 1.5rem;
        }
      }
      @media (max-width: 480px) {
        .merge-tool h1 {
          font-size: 1.3rem;
        }
      }
      .merge-tool p {
        font-size: 1rem;
      }
      @media (max-width: 768px) {
        .merge-tool p {
          font-size: 0.9rem;
        }
      }
      @media (max-width: 480px) {
        .merge-tool p {
          font-size: 0.85rem;
        }
      }
      .error-text {
        background: #fee2e2;
        border-left: 4px solid #ef4444;
        padding: 12px 16px;
        font-size: 14px;
        border-radius: 4px;
        color: #991b1b;
        line-height: 1.6;
      }
      @media (max-width: 768px) {
        .error-text {
          font-size: 13px;
          padding: 10px 14px;
        }
      }
      @media (max-width: 480px) {
        .error-text {
          font-size: 12px;
          padding: 10px 12px;
        }
      }
    </style>
  </head>

  <body>
    <section id="header-placeholder"></section>

    <main role="main">
      <section class="merge-tool">
        <div class="container">
          <h1>NextoPDF - Remove Watermark from PDF Online Free</h1>
          <p>
            Upload your PDF and click on any text or image to select watermarks
            for removal. Uses PyMuPDF for accurate detection and permanent
            deletion.
          </p>

          <div class="upload-section">
            <div id="uploadSection">
              <label class="upload-label" for="pdfUpload">
                <i class="fa fa-upload" aria-hidden="true"></i> Choose PDF file
              </label>
              <input
                type="file"
                id="pdfUpload"
                accept=".pdf"
                aria-label="Upload PDF file to remove watermarks"
              />
            </div>

            <ul id="fileList" class="file-list" role="list"></ul>

            <div
              class="success-message"
              id="successMsg"
              role="status"
              aria-live="polite"
            ></div>
            <div
              id="pagesGrid"
              class="pages-grid"
              style="display: none"
              role="region"
              aria-label="PDF pages with selectable watermarks"
            ></div>

            <div
              id="controlPanel"
              role="region"
              aria-label="Watermark removal controls"
            >
              <div class="control-content">
                <p
                  class="error-text"
                  id="errorMsg"
                  style="display: none; margin-bottom: 10px"
                  role="alert"
                  aria-live="assertive"
                ></p>
                <div
                  class="selection-info"
                  id="selectionInfo"
                  aria-live="polite"
                >
                  No items selected
                </div>
                <div class="action-buttons">
                  <button
                    id="clearBtn"
                    class="secondary-btn"
                    aria-label="Clear all selected watermarks"
                  >
                    <i class="fa fa-times" aria-hidden="true"></i> Clear
                    Selection
                  </button>
                  <button
                    id="deleteBtn"
                    class="cta-button"
                    style="background: #f59e0b"
                    aria-label="Delete selected watermarks"
                  >
                    <i class="fa fa-trash" aria-hidden="true"></i> Delete
                    Selected
                  </button>
                  <button
                    id="removeBtn"
                    class="cta-button"
                    aria-label="Save changes and download cleaned PDF"
                  >
                    <i class="fa fa-save" aria-hidden="true"></i> Save Changes
                  </button>
                </div>
              </div>
            </div>

            <div class="note-box" id="noteBox">
              ðŸ’¡ <strong>How it works:</strong> Click on text or images to
              select them (red border appears). Selected items can be deleted
              individually or in batch. Then click "Save Changes" to download
              your cleaned PDF.
            </div>

            <div id="resultBtns" style="display: none; margin-top: 30px">
              <div class="result-card">
                <i class="fa fa-file-pdf" aria-hidden="true"></i>
              </div>
              <p class="file-name">
                <a href="#" id="fileNameLink">cleaned.pdf</a>
              </p>
              <div class="result-btns-container">
                <a
                  id="downloadBtn"
                  href="#"
                  class="cta-button"
                  download
                  aria-label="Download cleaned PDF file"
                >
                  <i class="fa fa-download" aria-hidden="true"></i> Download
                </a>
                <a
                  id="shareBtn"
                  href="#"
                  class="cta-button"
                  aria-label="Share cleaned PDF file"
                >
                  <i class="fa fa-share-alt" aria-hidden="true"></i> Share
                </a>
                <button
                  id="resetBtn"
                  class="secondary-btn"
                  aria-label="Remove watermark from another PDF"
                >
                  <i class="fa fa-rotate-right" aria-hidden="true"></i> Remove
                  Another
                </button>
              </div>
            </div>
          </div>

          <div id="pdfPreview" style="display: none; margin-top: 30px">
            <h2>Preview Cleaned PDF</h2>
            <iframe
              id="pdfFrame"
              width="100%"
              height="600"
              title="Cleaned PDF preview"
              style="border-radius: 12px; border: 1px solid #e5e7eb"
            ></iframe>
          </div>
        </div>
      </section>

      <!-- All your existing content sections go here unchanged -->
    </main>

    <div
      class="loading-overlay"
      id="loadingOverlay"
      role="alert"
      aria-live="assertive"
    >
      <div class="loading-content">
        <div class="spinner"></div>
        <p id="loadingMsg">Processing PDF...</p>
      </div>
    </div>

    <section id="footer-placeholder"></section>

    <script src="./js/app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      const DETECT_PAGE_URL = `http://127.0.0.1:8080/detect-page-watermarks`;
      const REMOVE_URL = `http://127.0.0.1:8080/remove-watermark`;

      const pdfUpload = document.getElementById("pdfUpload");
      const uploadSection = document.getElementById("uploadSection");
      const fileList = document.getElementById("fileList");
      const pagesGrid = document.getElementById("pagesGrid");
      const controlPanel = document.getElementById("controlPanel");
      const selectionInfo = document.getElementById("selectionInfo");
      const clearBtn = document.getElementById("clearBtn");
      const deleteBtn = document.getElementById("deleteBtn");
      const removeBtn = document.getElementById("removeBtn");
      const errorMsg = document.getElementById("errorMsg");
      const successMsg = document.getElementById("successMsg");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const loadingMsg = document.getElementById("loadingMsg");
      const resultBtns = document.getElementById("resultBtns");
      const downloadBtn = document.getElementById("downloadBtn");
      const shareBtn = document.getElementById("shareBtn");
      const resetBtn = document.getElementById("resetBtn");
      const noteBox = document.getElementById("noteBox");
      const pdfPreview = document.getElementById("pdfPreview");
      const pdfFrame = document.getElementById("pdfFrame");
      const fileNameLink = document.getElementById("fileNameLink");

      let currentFile = null;
      let detectedItems = [];
      let selectedItems = new Set();
      let pageRenderScales = {};
      let detectingPages = new Set();
      let detectedPageNums = new Set();

      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

      // â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function showError(msg) {
        errorMsg.textContent = msg;
        errorMsg.style.display = "inline-block";
        successMsg.classList.remove("show");
      }
      function clearError() {
        errorMsg.style.display = "none";
      }
      function showSuccess(msg) {
        successMsg.textContent = msg;
        successMsg.classList.add("show");
        clearError();
        setTimeout(() => successMsg.classList.remove("show"), 3000);
      }
      function showLoading(msg = "Processing PDF...") {
        loadingMsg.textContent = msg;
        loadingOverlay.classList.add("show");
      }
      function hideLoading() {
        loadingOverlay.classList.remove("show");
      }

      function updateSelectionInfo() {
        const n = selectedItems.size;
        selectionInfo.textContent =
          n === 0
            ? "No items selected"
            : `${n} item${n > 1 ? "s" : ""} selected`;
      }

      function renderFileList() {
        fileList.style.display = "block";
        fileList.innerHTML = "";
        const li = document.createElement("li");
        li.innerHTML = `<i class="fa fa-file-pdf pdf-icon" aria-hidden="true"></i>
      <span>${currentFile.name}</span>
      <button class="delete-file" aria-label="Remove ${currentFile.name}">
        <i class="fa fa-times" aria-hidden="true"></i>
      </button>`;
        fileList.appendChild(li);
      }

      fileList.addEventListener("click", (e) => {
        if (e.target.closest(".delete-file")) resetApplication();
      });

      function resetApplication() {
        currentFile = null;
        detectedItems = [];
        selectedItems.clear();
        pageRenderScales = {};
        detectingPages.clear();
        detectedPageNums.clear();

        fileList.style.display = "none";
        fileList.innerHTML = "";
        uploadSection.style.display = "block";
        pagesGrid.style.display = "none";
        pagesGrid.innerHTML = "";
        controlPanel.style.display = "none";
        resultBtns.style.display = "none";
        pdfPreview.style.display = "none";
        noteBox.style.display = "block";
        pdfUpload.value = "";

        clearError();
        successMsg.classList.remove("show");
        pdfFrame.src = "";

        if (downloadBtn.href && downloadBtn.href.startsWith("blob:"))
          URL.revokeObjectURL(downloadBtn.href);
        if (shareBtn.href && shareBtn.href.startsWith("blob:"))
          URL.revokeObjectURL(shareBtn.href);
        downloadBtn.href = "#";
        shareBtn.href = "#";

        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // â”€â”€ Scale helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function calculateDisplayScale(pdfPageWidth) {
        const container = pagesGrid.closest(".container");
        const cw = container ? container.clientWidth : window.innerWidth;
        let maxWidth;
        if (window.innerWidth < 480) maxWidth = Math.min(cw - 40, 320);
        else if (window.innerWidth < 768) maxWidth = Math.min(cw - 60, 480);
        else if (window.innerWidth < 970) maxWidth = Math.min(cw - 80, 700);
        else maxWidth = Math.min(cw - 100, 800);
        return Math.max(maxWidth, 200) / pdfPageWidth;
      }

      // â”€â”€ Upload: render pages, no auto-detect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      pdfUpload.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        clearError();
        currentFile = file;
        selectedItems.clear();
        detectedItems = [];
        pageRenderScales = {};
        detectingPages.clear();
        detectedPageNums.clear();

        uploadSection.style.display = "none";
        renderFileList();
        showLoading("Loading PDF...");

        try {
          await renderPDFPages(file);
          hideLoading();
          controlPanel.style.display = "block";
          pagesGrid.style.display = "flex";
        } catch (err) {
          hideLoading();
          showError("Error loading PDF: " + err.message);
          resetApplication();
        }
      };

      // â”€â”€ Render all pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      async function renderPDFPages(file) {
        pagesGrid.innerHTML = "";
        pageRenderScales = {};

        const fileURL = URL.createObjectURL(file);
        const pdf = await pdfjsLib.getDocument({
          url: fileURL,
          cMapUrl: "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/",
          cMapPacked: true,
          verbosity: 0,
        }).promise;

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const vp = page.getViewport({ scale: 1 });
          const dScale = calculateDisplayScale(vp.width);
          pageRenderScales[pageNum] = dScale;

          const rScale = dScale * (window.devicePixelRatio || 2);
          const rVp = page.getViewport({ scale: rScale });
          const canvas = document.createElement("canvas");
          canvas.width = rVp.width;
          canvas.height = rVp.height;
          await page.render({
            canvasContext: canvas.getContext("2d", { alpha: false }),
            viewport: rVp,
          }).promise;
          canvas.style.width = vp.width * dScale + "px";
          canvas.style.height = vp.height * dScale + "px";

          const card = document.createElement("div");
          card.className = "page-card";
          card.dataset.pageNum = pageNum;

          const badge = document.createElement("div");
          badge.className = "page-number-badge";
          badge.textContent = `Page ${pageNum}`;
          card.appendChild(badge);

          const canvasContainer = document.createElement("div");
          canvasContainer.className = "page-canvas-container";
          canvasContainer.id = `canvas-container-${pageNum}`;
          canvasContainer.appendChild(canvas);
          card.appendChild(canvasContainer);

          const detectBtn = document.createElement("button");
          detectBtn.className = "cta-button";
          detectBtn.id = `detect-btn-${pageNum}`;
          detectBtn.style.cssText =
            "margin-top:12px;width:100%;padding:10px;font-size:14px;" +
            "display:flex;align-items:center;justify-content:center;gap:8px;";
          detectBtn.innerHTML = `<i class="fa fa-search"></i> Detect Watermarks`;
          detectBtn.onclick = () => detectPageWatermarks(pageNum);

          if (detectedPageNums.has(pageNum)) {
            detectBtn.style.display = "none";
          }

          card.appendChild(detectBtn);
          pagesGrid.appendChild(card);
          page.cleanup();
        }

        URL.revokeObjectURL(fileURL);
      }

      // â”€â”€ Per-page detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      async function detectPageWatermarks(pageNum, silent = false) {
        if (detectingPages.has(pageNum)) return;
        detectingPages.add(pageNum);

        const btn = document.getElementById(`detect-btn-${pageNum}`);

        if (!silent) {
          if (btn) {
            btn.disabled = true;
            btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> Detecting...`;
          }
        }
        clearError();

        try {
          const formData = new FormData();
          formData.append("file", currentFile);
          formData.append("page", pageNum);

          const res = await fetch(DETECT_PAGE_URL, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || "Detection failed");
          }

          const data = await res.json();
          const pageItems = data.items || [];

          const idOffset = detectedItems.length;
          pageItems.forEach((item, i) => {
            item.id = idOffset + i;
          });

          detectedItems = detectedItems.filter((i) => i.page !== pageNum);
          detectedItems.push(...pageItems);
          detectedPageNums.add(pageNum);

          const container = document.getElementById(
            `canvas-container-${pageNum}`,
          );
          if (container) {
            // Clear ALL stale overlays before drawing fresh ones
            container.querySelectorAll(".watermark-overlay").forEach((el) => {
              el.style.pointerEvents = "none";
              el.remove();
            });
            const dScale = pageRenderScales[pageNum] || 1;
            pageItems
              .filter((i) => i.type === "image")
              .forEach((item) =>
                container.appendChild(createOverlay(item, dScale)),
              );
            pageItems
              .filter((i) => i.type === "text")
              .forEach((item) =>
                container.appendChild(createOverlay(item, dScale)),
              );
          }

          if (btn) btn.style.display = "none";

          if (!silent) {
            showSuccess(
              `Page ${pageNum}: ${pageItems.length} item${pageItems.length !== 1 ? "s" : ""} detected`,
            );
          }
        } catch (err) {
          if (!silent && btn) {
            btn.disabled = false;
            btn.innerHTML = `<i class="fa fa-search"></i> Detect Watermarks`;
          }
          showError(`Page ${pageNum}: ${err.message}`);
        } finally {
          detectingPages.delete(pageNum);
        }
      }

      // â”€â”€ Create overlay div â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function createOverlay(item, dScale) {
        const [x0, y0, x1, y1] = item.bbox;

        const overlay = document.createElement("div");
        overlay.className = `watermark-overlay type-${item.type}`;
        overlay.dataset.itemId = item.id;
        overlay.dataset.pageNum = item.page;
        overlay.setAttribute("role", "button");
        overlay.setAttribute("tabindex", "0");
        overlay.setAttribute(
          "aria-label",
          item.type === "text"
            ? `Text: ${(item.text || "").substring(0, 30)}. Click to select.`
            : "Image. Click to select.",
        );

        overlay.style.left = x0 * dScale + "px";
        overlay.style.top = y0 * dScale + "px";
        overlay.style.width = Math.max((x1 - x0) * dScale, 4) + "px";
        overlay.style.height = Math.max((y1 - y0) * dScale, 4) + "px";
        overlay.style.zIndex = item.type === "text" ? "20" : "10";

        const label = document.createElement("div");
        label.className = "overlay-label";
        label.textContent =
          item.type === "text"
            ? `Text: ${(item.text || "").substring(0, 30)}`
            : "Image";
        overlay.appendChild(label);

        const deleteIcon = document.createElement("div");
        deleteIcon.className = "delete-icon";
        deleteIcon.innerHTML = '<i class="fa fa-times"></i>';
        deleteIcon.setAttribute("role", "button");
        deleteIcon.setAttribute("tabindex", "0");
        overlay.appendChild(deleteIcon);

        overlay.onclick = (e) => {
          if (e.target.closest(".delete-icon")) return;
          toggleSelection(item.id, overlay);
        };
        overlay.onkeydown = (e) => {
          if (
            (e.key === "Enter" || e.key === " ") &&
            !e.target.closest(".delete-icon")
          ) {
            e.preventDefault();
            toggleSelection(item.id, overlay);
          }
        };
        deleteIcon.onclick = (e) => {
          e.stopPropagation();
          deleteSingleWatermark(item.id);
        };
        deleteIcon.onkeydown = (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            e.stopPropagation();
            deleteSingleWatermark(item.id);
          }
        };

        return overlay;
      }

      // â”€â”€ Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function toggleSelection(itemId, overlay) {
        if (selectedItems.has(itemId)) {
          selectedItems.delete(itemId);
          overlay.classList.remove("selected");
          overlay.setAttribute("aria-pressed", "false");
        } else {
          selectedItems.add(itemId);
          overlay.classList.add("selected");
          overlay.setAttribute("aria-pressed", "true");
          clearError();
        }
        updateSelectionInfo();
      }

      // â”€â”€ Helper: nuke all overlays for a page from the DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function clearPageOverlays(pageNum) {
        // Primary: remove from canvas container
        const canvasContainer = document.getElementById(
          `canvas-container-${pageNum}`,
        );
        if (canvasContainer) {
          canvasContainer
            .querySelectorAll(".watermark-overlay")
            .forEach((el) => {
              el.style.pointerEvents = "none";
              el.remove();
            });
        }
        // Safety net: remove any orphaned overlays anywhere in the DOM
        document
          .querySelectorAll(`.watermark-overlay[data-page-num="${pageNum}"]`)
          .forEach((el) => {
            el.style.pointerEvents = "none";
            el.remove();
          });
      }

      // â”€â”€ Re-render a single page then restore overlays â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      async function reRenderPage(pageNum) {
        const fileURL = URL.createObjectURL(currentFile);
        const pdf = await pdfjsLib.getDocument({
          url: fileURL,
          cMapUrl: "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/",
          cMapPacked: true,
          verbosity: 0,
        }).promise;

        const page = await pdf.getPage(pageNum);
        const vp = page.getViewport({ scale: 1 });
        const dScale = calculateDisplayScale(vp.width);
        pageRenderScales[pageNum] = dScale;

        const rScale = dScale * (window.devicePixelRatio || 2);
        const rVp = page.getViewport({ scale: rScale });
        const canvas = document.createElement("canvas");
        canvas.width = rVp.width;
        canvas.height = rVp.height;
        await page.render({
          canvasContext: canvas.getContext("2d", { alpha: false }),
          viewport: rVp,
        }).promise;
        canvas.style.width = vp.width * dScale + "px";
        canvas.style.height = vp.height * dScale + "px";

        const canvasContainer = document.getElementById(
          `canvas-container-${pageNum}`,
        );

        // Wipe everything â€” canvas + any lingering overlay divs
        while (canvasContainer.firstChild) {
          canvasContainer.removeChild(canvasContainer.firstChild);
        }
        canvasContainer.appendChild(canvas);

        // Redraw only surviving overlays (empty if detectedItems was cleared)
        const remaining = detectedItems.filter((i) => i.page === pageNum);
        remaining
          .filter((i) => i.type === "image")
          .forEach((item) =>
            canvasContainer.appendChild(createOverlay(item, dScale)),
          );
        remaining
          .filter((i) => i.type === "text")
          .forEach((item) =>
            canvasContainer.appendChild(createOverlay(item, dScale)),
          );

        // Keep detect button hidden â€” page is already detected
        const btn = document.getElementById(`detect-btn-${pageNum}`);
        if (btn) btn.style.display = "none";

        page.cleanup();
        URL.revokeObjectURL(fileURL);
      }

      // â”€â”€ Delete single item (X button) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      async function deleteSingleWatermark(itemId) {
        const item = detectedItems.find((i) => i.id === itemId);
        if (!item) return;

        showLoading("Removing watermark...");
        clearError();

        try {
          const formData = new FormData();
          formData.append("files", currentFile);
          formData.append("watermarks", JSON.stringify([item]));

          const res = await fetch(REMOVE_URL, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || "Failed to remove");
          }

          const blob = await res.blob();
          currentFile = new File([blob], currentFile.name, {
            type: "application/pdf",
          });

          const pageNum = item.page;
          const wasImage = item.type === "image";

          // Remove this item from detectedItems and selectedItems
          detectedItems = detectedItems.filter((i) => i.id !== itemId);
          selectedItems.delete(itemId);
          detectedItems.forEach((it, idx) => {
            it.id = idx;
          });

          if (wasImage) {
            // 1. Immediately disable hover + remove ALL overlay divs for this page
            clearPageOverlays(pageNum);

            // 2. Clear stale detectedItems for this page
            detectedItems = detectedItems.filter((i) => i.page !== pageNum);
            detectedPageNums.delete(pageNum);

            // 3. Re-render canvas (no overlays drawn â€” detectedItems is empty for page)
            await reRenderPage(pageNum);

            // 4. Re-detect silently to get fresh items and draw new overlays
            await detectPageWatermarks(pageNum, true);
          } else {
            // Text deleted â€” redraw canvas + surviving overlays from detectedItems
            await reRenderPage(pageNum);
          }

          updateSelectionInfo();
          hideLoading();
          showSuccess("Watermark removed");
        } catch (err) {
          hideLoading();
          showError("Error: " + err.message);
        }
      }

      // â”€â”€ Clear selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      clearBtn.onclick = () => {
        const selected = document.querySelectorAll(
          ".watermark-overlay.selected",
        );
        if (!selected.length) {
          showError("No items selected to clear");
          return;
        }
        selectedItems.clear();
        selected.forEach((el) => {
          el.classList.remove("selected");
          el.setAttribute("aria-pressed", "false");
        });
        updateSelectionInfo();
        clearError();
      };

      // â”€â”€ Delete selected batch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      deleteBtn.onclick = async () => {
        if (!selectedItems.size) {
          showError("Please select items to delete first!");
          return;
        }
        showLoading("Removing selected watermarks...");
        clearError();

        try {
          const itemsToRemove = Array.from(selectedItems)
            .map((id) => detectedItems.find((i) => i.id === id))
            .filter(Boolean);
          const affectedPages = [...new Set(itemsToRemove.map((i) => i.page))];

          const formData = new FormData();
          formData.append("files", currentFile);
          formData.append("watermarks", JSON.stringify(itemsToRemove));

          const res = await fetch(REMOVE_URL, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || "Failed to delete");
          }

          const blob = await res.blob();
          currentFile = new File([blob], currentFile.name, {
            type: "application/pdf",
          });

          const imageRemovedPages = new Set(
            itemsToRemove.filter((i) => i.type === "image").map((i) => i.page),
          );

          // Remove all selected items from detectedItems
          detectedItems = detectedItems.filter((i) => !selectedItems.has(i.id));
          detectedItems.forEach((it, idx) => {
            it.id = idx;
          });
          selectedItems.clear();

          for (const pn of affectedPages) {
            if (imageRemovedPages.has(pn)) {
              // 1. Immediately disable hover + remove ALL overlay divs for this page
              clearPageOverlays(pn);

              // 2. Clear stale detectedItems and page tracking
              detectedItems = detectedItems.filter((i) => i.page !== pn);
              detectedPageNums.delete(pn);

              // 3. Re-render canvas (no overlays â€” detectedItems empty for page)
              await reRenderPage(pn);

              // 4. Re-detect silently
              await detectPageWatermarks(pn, true);
            } else {
              // Text-only deletions â€” redraw canvas + surviving overlays
              await reRenderPage(pn);
            }
          }

          updateSelectionInfo();
          hideLoading();
          showSuccess(
            `Deleted ${itemsToRemove.length} watermark${itemsToRemove.length !== 1 ? "s" : ""}`,
          );
        } catch (err) {
          hideLoading();
          showError("Error: " + err.message);
        }
      };

      // â”€â”€ Save Changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      removeBtn.onclick = () => {
        const url = URL.createObjectURL(currentFile);
        downloadBtn.href = url;
        downloadBtn.download = "cleaned.pdf";
        shareBtn.href = url;

        uploadSection.style.display = "none";
        fileList.style.display = "none";
        pagesGrid.style.display = "none";
        controlPanel.style.display = "none";
        noteBox.style.display = "none";
        resultBtns.style.display = "block";

        const isSmall = window.matchMedia("(max-width:768px)").matches;
        if (!isSmall) {
          pdfFrame.src = url;
          pdfPreview.style.display = "block";
        }
        fileNameLink.onclick = (e) => {
          e.preventDefault();
          isSmall
            ? window.open(url, "_blank")
            : pdfPreview.scrollIntoView({ behavior: "smooth" });
        };
      };

      resetBtn.onclick = () => resetApplication();

      // â”€â”€ Resize: re-render pages, restore detected overlays â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      let resizeTimeout;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(async () => {
          if (!currentFile || pagesGrid.style.display === "none") return;

          const prevDetected = [...detectedItems];
          const prevDetectedNums = new Set(detectedPageNums);

          await renderPDFPages(currentFile);

          detectedItems = prevDetected;
          detectedPageNums = prevDetectedNums;

          for (const pageNum of detectedPageNums) {
            const container = document.getElementById(
              `canvas-container-${pageNum}`,
            );
            if (!container) continue;
            const dScale = pageRenderScales[pageNum] || 1;
            const items = detectedItems.filter((i) => i.page === pageNum);
            items
              .filter((i) => i.type === "image")
              .forEach((item) =>
                container.appendChild(createOverlay(item, dScale)),
              );
            items
              .filter((i) => i.type === "text")
              .forEach((item) =>
                container.appendChild(createOverlay(item, dScale)),
              );
            const btn = document.getElementById(`detect-btn-${pageNum}`);
            if (btn) btn.style.display = "none";
          }
        }, 300);
      });
    </script>
  </body>
</html>
