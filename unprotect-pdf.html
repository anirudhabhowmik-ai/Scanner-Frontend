<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDFMaster - Unlock PDF Online</title>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Inter:wght@400;500&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Main CSS -->
    <link rel="stylesheet" href="./css/style.css" />

    <style>
      .error-text {
        color: #d9534f;
        margin-top: 5px;
        font-size: 14px;
      }
      .info-box {
        display: flex;
        justify-content: center;
        align-items: center;
        background: #e7f3ff;
        border-left: 4px solid #2196f3;
        padding: 12px 16px;
        margin: 15px 0;
        border-radius: 4px;
      }
      .info-box i {
        color: #2196f3;
        margin-right: 8px;
      }
      .info-box p {
        margin: 0;
        font-size: 14px;
        color: #333;
      }
      .password-container {
        position: relative;
        margin: 15px 0;
        display: none;
      }
      .password-container label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }
      .password-input-wrapper {
        position: relative;
      }
      .password-input {
        width: 100%;
        padding: 12px 40px 12px 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
        box-sizing: border-box;
      }
      .password-input:focus {
        outline: none;
        border-color: #007bff;
      }
      .toggle-password {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #555;
        transition: color 0.3s;
      }
      .toggle-password:hover {
        color: #007bff;
      }
      .password-hint {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      .warning-box {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 12px 16px;
        margin: 15px 0;
        border-radius: 4px;
      }
      .warning-box i {
        color: #ffc107;
        margin-right: 8px;
      }
      .warning-box p {
        margin: 0;
        font-size: 14px;
        color: #856404;
      }
      .result-btns-container {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <section id="header-placeholder"></section>

    <section class="merge-tool">
      <div class="container">
        <h1>Unlock PDF</h1>
        <p>
          Remove password protection and restrictions from your PDFs. Works
          automatically for restriction-only PDFs.
        </p>

        <div class="upload-section" id="uploadWrapper">
          <div id="uploadSection">
            <label class="upload-label">
              <i class="fa fa-upload"></i> Choose PDF files
              <input type="file" id="pdfUpload" accept=".pdf" hidden />
            </label>
          </div>

          <ul id="fileList" class="file-list" style="display: none"></ul>

          <!-- Password Input (Initially Hidden) -->
          <div class="password-container" id="passwordContainer">
            <div class="warning-box">
              <i class="fa fa-lock"></i>
              <p id="passwordWarning">
                <strong>Password Required:</strong> Your PDF(s) are
                password-protected. Please enter the password below.
              </p>
            </div>
            <label for="pdfPassword">PDF Password</label>
            <div class="password-input-wrapper">
              <input
                type="password"
                id="pdfPassword"
                class="password-input"
                placeholder="Enter PDF password"
              />
              <i class="fa fa-eye toggle-password" id="togglePassword"></i>
            </div>
            <p class="password-hint">
              Enter the password used to protect this PDF
            </p>
          </div>

          <button id="unlockBtn" class="cta-button">
            <i
              class="fa fa-spinner fa-spin"
              id="loader"
              style="display: none; margin-left: 5px"
            ></i>
            <span id="unlockBtnText">
              <i class="fa fa-unlock"></i></span> Unlock PDFs
          </button>

          <p id="errorMsg" class="error-text" style="display: none"></p>

          <div class="info-box" id="infoBox">
            <i class="fa fa-info-circle"></i>
            <p>
              <strong>How it works:</strong> We'll try to unlock your PDFs
              automatically. If they require a password, you'll be prompted to
              enter it.
            </p>
          </div>
        </div>

        <div id="resultBtns" style="display: none; margin-top: 20px">
          <div id="resultCard" class="result-card">
            <i
              class="fa fa-check-circle"
              style="color: #28a745; font-size: 48px"
            ></i>
          </div>
          <p class="file-name">
            <strong>Success!</strong> Your PDF(s) have been unlocked
          </p>

          <div class="result-btns-container">
            <a id="downloadBtn" class="cta-button">
              <i class="fa fa-download"></i> Download Unlocked Files
            </a>
            <a id="shareBtn" class="cta-button" style="display: none">
              <i class="fa fa-share-alt"></i> Share
            </a>
            <button id="resetBtn" class="secondary-btn">
              <i class="fa fa-rotate-right"></i> Unlock Another PDF
            </button>
          </div>
        </div>
      </div>
    </section>

    <section id="footer-placeholder"></section>

    <script src="./js/app.js"></script>
    <script>
      const BACKEND_UNPROTECT_URL = `${BACKEND_BASE_URL}/unprotect-pdf`;

      const pdfInput = document.getElementById("pdfUpload");
      const unlockBtn = document.getElementById("unlockBtn");
      const unlockBtnText = document.getElementById("unlockBtnText");
      const loader = document.getElementById("loader");
      const resultSection = document.getElementById("resultBtns");
      const downloadBtn = document.getElementById("downloadBtn");
      const shareBtn = document.getElementById("shareBtn");
      const resetBtn = document.getElementById("resetBtn");
      const fileList = document.getElementById("fileList");
      const errorMsg = document.getElementById("errorMsg");
      const uploadWrapper = document.getElementById("uploadWrapper");
      const passwordContainer = document.getElementById("passwordContainer");
      const passwordInput = document.getElementById("pdfPassword");
      const togglePassword = document.getElementById("togglePassword");
      const passwordWarning = document.getElementById("passwordWarning");

      let selectedFiles = [];
      let passwordRequired = false;

      // Toggle password visibility
      togglePassword.addEventListener("click", () => {
        const type = passwordInput.type === "password" ? "text" : "password";
        passwordInput.type = type;
        togglePassword.classList.toggle("fa-eye");
        togglePassword.classList.toggle("fa-eye-slash");
      });

      // File selection
      pdfInput.addEventListener("change", () => {
        selectedFiles = Array.from(pdfInput.files);
        fileList.innerHTML = "";
        passwordContainer.style.display = "none";
        passwordRequired = false;
        passwordInput.value = "";

        if (selectedFiles.length > 0) {
          fileList.style.display = "block";
          selectedFiles.forEach((file) => {
            const listItem = document.createElement("li");
            listItem.innerHTML = `<span><i class="fa fa-file-pdf pdf-icon"></i><span>${file.name}</span></span><i class="fa fa-times delete-file"></i>`;
            fileList.appendChild(listItem);
          });
        } else {
          fileList.style.display = "none";
        }
        errorMsg.style.display = "none";
      });

      // Delete file from list
      fileList.addEventListener("click", (e) => {
        if (e.target.classList.contains("delete-file")) {
          const fileNameSpan =
            e.target.previousElementSibling.querySelector("span:last-child");
          const fileName = fileNameSpan ? fileNameSpan.textContent.trim() : "";

          selectedFiles = selectedFiles.filter(
            (file) => file.name !== fileName,
          );
          e.target.closest("li").remove();

          if (selectedFiles.length === 0) {
            fileList.style.display = "none";
            passwordContainer.style.display = "none";
          }
        }
      });

      // Unlock PDFs
      unlockBtn.addEventListener("click", async () => {
        if (selectedFiles.length === 0) {
          errorMsg.textContent = "Please select at least one PDF file.";
          errorMsg.style.display = "block";
          return;
        }

        // If password is required but not provided
        if (passwordRequired && !passwordInput.value.trim()) {
          errorMsg.textContent = "Please enter the PDF password.";
          errorMsg.style.display = "block";
          passwordInput.focus();
          return;
        }

        errorMsg.style.display = "none";
        unlockBtnText.style.display = "none";
        loader.style.display = "inline-block";
        unlockBtn.disabled = true;

        const formData = new FormData();
        selectedFiles.forEach((file) => formData.append("files", file));

        // Add password if provided
        const password = passwordInput.value.trim();
        if (password) {
          formData.append("password", password);
        }

        try {
          const response = await fetch(BACKEND_UNPROTECT_URL, {
            method: "POST",
            body: formData,
          });

          // Check if password is required (401 status)
          if (response.status === 401) {
            const errorData = await response.json();

            if (errorData.error === "password_required") {
              // Show password input
              passwordContainer.style.display = "block";
              passwordRequired = true;
              passwordWarning.innerHTML = `<strong>Password Required:</strong> ${errorData.message}`;
              errorMsg.textContent = "Please enter the password and try again.";
              errorMsg.style.display = "block";
              passwordInput.focus();
              return;
            }
          }

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.message || errorData.error || "Failed to unlock PDFs",
            );
          }

          const blob = await response.blob();
          const url = URL.createObjectURL(blob);

          // Hide upload section and show results
          uploadWrapper.style.display = "none";
          resultSection.style.display = "block";

          const contentDisposition = response.headers.get(
            "Content-Disposition",
          );
          let fileName = "unlocked_pdfs.zip";

          if (contentDisposition) {
            const matches = contentDisposition.match(
              /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/,
            );
            if (matches && matches[1]) {
              fileName = matches[1].replace(/['"]/g, "");
            }
          }

          downloadBtn.href = url;
          downloadBtn.download = fileName;

          shareBtn.style.display = "inline-flex";
          shareBtn.onclick = () => {
            if (navigator.share) {
              navigator.share({
                title: "Unlocked PDF(s)",
                text: "Here are your unlocked PDFs.",
                url: url,
              });
            } else {
              alert("Sharing is not supported on this device.");
            }
          };
        } catch (err) {
          errorMsg.textContent =
            err.message || "Error unlocking PDFs. Please try again.";
          errorMsg.style.display = "block";
        } finally {
          unlockBtnText.style.display = "inline";
          loader.style.display = "none";
          unlockBtn.disabled = false;
        }
      });

      // Reset form
      resetBtn.addEventListener("click", () => {
        pdfInput.value = "";
        passwordInput.value = "";
        selectedFiles = [];
        passwordRequired = false;
        fileList.style.display = "none";
        passwordContainer.style.display = "none";
        uploadWrapper.style.display = "flex";
        resultSection.style.display = "none";
        errorMsg.style.display = "none";
        shareBtn.style.display = "none";
      });
    </script>
  </body>
</html>
